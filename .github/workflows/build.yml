name: Build OpenWrt Package with SDK

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'feature-*'
      - 'fix/**'
      - 'fix-*'
      - 'chore/**'
      - 'chore-*'
      - 'docs/**'
      - 'docs-*'
      - 'hotfix/**'
      - 'hotfix-*'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  OPENWRT_VERSION: "23.05.3"
  OPENWRT_ARCH: "x86_64"
  SDK_CACHE_VERSION: "v2"
  SDK_CHECKSUM: "f90d60c7a00a50a1c80807fb32fd4c12bed1fb65871328f3c2171caf9b711254"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        linter:
          - shfmt
          - shellcheck
          - markdownlint
          - actionlint
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install dependencies
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          case "${{ matrix.linter }}" in
            shfmt|shellcheck)
              sudo apt-get install -y busybox shfmt shellcheck
              ;;
            markdownlint|actionlint)
              echo "Using docker-based linters"
              ;;
          esac

      - name: Run shfmt
        if: matrix.linter == 'shfmt'
        run: |
          set -euo pipefail
          shfmt -d -s -i 4 -ci -sr .

      - name: Run shellcheck
        if: matrix.linter == 'shellcheck'
        run: |
          set -euo pipefail
          find . -type f -name "*.sh" -exec shellcheck {} +
          shellcheck openwrt_captive_monitor.sh

      - name: Run markdownlint
        if: matrix.linter == 'markdownlint'
        uses: DavidAnson/markdownlint-cli2-action@v20
        with:
          config: '.markdownlint.json'
          files: '**/*.md'

      - name: Run actionlint
        if: matrix.linter == 'actionlint'
        uses: reviewdog/action-actionlint@v1

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install BusyBox and test dependencies
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install -y busybox

      - name: Run test harness with BusyBox ash
        run: |
          set -euo pipefail
          busybox ash tests/run.sh

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results
          path: tests/_out/
          retention-days: 7
          if-no-files-found: warn

  build-sdk:
    name: Build with OpenWrt SDK
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download test results
        uses: actions/download-artifact@v6
        with:
          name: test-results
          path: tests/_out/
        continue-on-error: true

      - name: Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: |
            openwrt-sdk-*
            sdk-cache
          key: ${{ runner.os }}-openwrt-sdk-${{ env.OPENWRT_VERSION }}-${{ env.OPENWRT_ARCH }}-${{ env.SDK_CACHE_VERSION }}
          restore-keys: |
            ${{ runner.os }}-openwrt-sdk-${{ env.OPENWRT_VERSION }}-${{ env.OPENWRT_ARCH }}-

      - name: Cache OpenWrt feeds
        id: cache-feeds
        uses: actions/cache@v4
        with:
          path: |
            openwrt-sdk-*/feeds/
            openwrt-sdk-*/dl/
          key: ${{ runner.os }}-openwrt-feeds-${{ env.OPENWRT_VERSION }}-${{ env.OPENWRT_ARCH }}-${{ hashFiles('package/*/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-feeds-${{ env.OPENWRT_VERSION }}-${{ env.OPENWRT_ARCH }}-

      - name: Install build dependencies
        run: |
          set -euxo pipefail
          sudo rm -f /etc/apt/sources.list.d/microsoft*.list
          
          # Configure apt for network resilience
          echo 'Acquire::http::Timeout "30";' | sudo tee -a /etc/apt/apt.conf.d/99timeout
          echo 'Acquire::https::Timeout "30";' | sudo tee -a /etc/apt/apt.conf.d/99timeout
          echo 'Acquire::Retries "3";' | sudo tee -a /etc/apt/apt.conf.d/99retry
          
          # Update with retry logic
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Updating package lists..."
            if sudo apt-get update \
              -o Acquire::http::Timeout=30 \
              -o Acquire::https::Timeout=30 \
              -o Acquire::Retries=3; then
              echo "âœ“ Package update successful"
              break
            else
              if [ "$attempt" -lt 3 ]; then
                echo "âœ— Package update failed, retrying in 10s..."
                sleep 10
              else
                echo "âŒ Package update failed after 3 attempts"
                exit 1
              fi
            fi
          done
          
          # Install dependencies with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Installing dependencies..."
            if sudo apt-get -o Acquire::http::Timeout=30 \
              -o Acquire::https::Timeout=30 \
              -o Acquire::Retries=3 \
              install -y --no-install-recommends \
              build-essential \
              ccache \
              curl \
              file \
              g++ \
              gawk \
              gcc \
              gettext \
              git \
              libncurses5-dev \
              libssl-dev \
              make \
              perl \
              python3 \
              python3-dev \
              rsync \
              unzip \
              wget \
              zlib1g-dev \
              libncursesw5-dev \
              libgmp-dev \
              libmpfr-dev \
              libmpc-dev \
              flex \
              bison; then
              echo "âœ“ Dependencies installed successfully"
              break
            else
              if [ "$attempt" -lt 3 ]; then
                echo "âœ— Dependency installation failed, retrying in 10s..."
                sleep 10
              else
                echo "âŒ Dependency installation failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Download OpenWrt SDK from GitHub CDN
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          SDK_VERSION="${{ env.OPENWRT_VERSION }}"
          SDK_FILE="openwrt-sdk-${SDK_VERSION}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          SDK_CHECKSUM="${{ env.SDK_CHECKSUM }}"
          
          # Use GitHub Release CDN (fast mirror)
          SDK_URL="https://github.com/nagual2/openwrt-captive-monitor/releases/download/sdk-${SDK_VERSION}/${SDK_FILE}"
          
          # Fallback to official mirror if CDN fails
          FALLBACK_URL="https://downloads.openwrt.org/releases/${SDK_VERSION}/targets/x86/64/${SDK_FILE}"
          
          echo "=== Downloading OpenWrt SDK from GitHub CDN ==="
          echo "Primary URL: $SDK_URL"
          echo "Fallback URL: $FALLBACK_URL"
          echo "Expected checksum: $SDK_CHECKSUM"
          
          echo "ðŸ“¥ Downloading SDK from GitHub CDN (fast)..."
          # Enhanced retry logic for CDN download
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Downloading from CDN..."
            if wget --timeout=120 --tries=1 --retry-connrefused --waitretry=2 \
                   --random-wait -q "$SDK_FILE" "$SDK_URL" 2>/dev/null; then
              echo "âœ“ CDN download successful"
              break
            else
              if [ "$attempt" -lt 3 ]; then
                wait_time=$((2 ** (attempt - 1)))
                echo "âœ— CDN download failed, retrying in ${wait_time}s..."
                sleep "$wait_time"
              else
                echo "âš ï¸  CDN failed after 3 attempts, falling back to official mirror..."
                wget --timeout=300 --tries=3 -O "$SDK_FILE" "$FALLBACK_URL"
              fi
            fi
          done
          
          echo "=== Verifying SDK download ==="
          if [ ! -f "$SDK_FILE" ]; then
            echo "ERROR: SDK download failed"
            exit 1
          fi
          
          SDK_SIZE=$(stat -c%s "$SDK_FILE")
          echo "SDK size: $SDK_SIZE bytes"
          
          if [ "$SDK_SIZE" -lt 100000000 ]; then
            echo "ERROR: SDK file too small, download may be incomplete"
            exit 1
          fi
          
          echo "=== Verifying SDK checksum ==="
          ACTUAL_SHA=$(sha256sum "$SDK_FILE" | cut -d' ' -f1)
          if [ "$SDK_CHECKSUM" != "$ACTUAL_SHA" ]; then
            echo "ERROR: SDK checksum verification failed!"
            echo "Expected: ${SDK_CHECKSUM}"
            echo "Actual:   ${ACTUAL_SHA}"
            exit 1
          fi
          
          echo "âœ“ SDK checksum verification passed"

      - name: Extract OpenWrt SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          SDK_FILE="openwrt-sdk-${{ env.OPENWRT_VERSION }}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          
          echo "=== Extracting OpenWrt SDK ==="
          tar -xf "$SDK_FILE"
          
          SDK_DIR="openwrt-sdk-${{ env.OPENWRT_VERSION }}-x86-64_gcc-12.3.0_musl.Linux-x86_64"
          if [ ! -d "$SDK_DIR" ]; then
            echo "ERROR: SDK extraction failed"
            exit 1
          fi
          
          echo "=== Verifying SDK structure ==="
          [ -f "$SDK_DIR/Makefile" ] || { echo "ERROR: SDK Makefile not found"; exit 1; }
          [ -d "$SDK_DIR/package" ] || { echo "ERROR: SDK package directory not found"; exit 1; }
          [ -d "$SDK_DIR/scripts" ] || { echo "ERROR: SDK scripts directory not found"; exit 1; }
          
          echo "SDK extracted successfully to: $SDK_DIR"

      - name: Find SDK directory
        id: sdk
        run: |
          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -n1)
          if [ -z "$SDK_DIR" ]; then
            echo "ERROR: SDK directory not found"
            exit 1
          fi
          echo "sdk_dir=$SDK_DIR" >> "$GITHUB_OUTPUT"
          echo "Found SDK directory: $SDK_DIR"

      - name: Setup SDK environment
        run: |
          set -euxo pipefail
          SDK_DIR="${{ steps.sdk.outputs.sdk_dir }}"
          
          echo "=== Setting up SDK environment ==="
          cd "$SDK_DIR"
          
          # Verify SDK is working
          make defconfig
          
          echo "SDK environment setup complete"

      - name: Clean SDK environment
        run: |
          set -euxo pipefail
          SDK_DIR="${{ steps.sdk.outputs.sdk_dir }}"
          
          echo "=== Cleaning SDK environment ==="
          cd "$SDK_DIR"
          
          # Clean previous build artifacts
          make distclean || true
          
          # Use defconfig in CI for consistent configuration
          make defconfig < /dev/null || {
            echo "defconfig failed, trying fallback configuration..."
            make defconfig
          }
          
          echo "SDK environment cleaned successfully"

      - name: Copy package to SDK
        run: |
          set -euxo pipefail
          SDK_DIR="${{ steps.sdk.outputs.sdk_dir }}"
          
          echo "=== Copying package to SDK ==="
          cp -r package/openwrt-captive-monitor "$SDK_DIR/package/"
          
          # Verify package structure
          PKG_DIR="$SDK_DIR/package/openwrt-captive-monitor"
          [ -f "$PKG_DIR/Makefile" ] || { echo "ERROR: Package Makefile not found"; exit 1; }
          [ -d "$PKG_DIR/files" ] || { echo "ERROR: Package files directory not found"; exit 1; }
          
          echo "Package copied successfully"

      - name: Update feeds
        run: |
          set -euo pipefail
          SDK_DIR="${{ steps.sdk.outputs.sdk_dir }}"
          
          echo "=== Updating OpenWrt feeds ==="
          cd "$SDK_DIR"
          
          # Configure Git for large transfers
          git config --global http.postBuffer 524288000
          git config --global core.compression 0
          
          # Function to update feeds with exponential backoff and jitter
          update_feeds_with_retry() {
            local max_attempts=10
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts: Updating feeds..."
              
              # Clear cache before each attempt to prevent stale data
              echo "Clearing feed cache before attempt $attempt..."
              rm -rf feeds/
              rm -f feeds.conf.old
              
              if ./scripts/feeds update -a; then
                echo "âœ“ Feeds updated successfully"
                return 0
              fi
              
              if [ $attempt -lt $max_attempts ]; then
                # Exponential backoff with jitter (1s, 2s, 4s, 8s, 16s, 32s, 64s, 128s, 256s)
                local base_wait=$((2 ** (attempt - 1)))
                # Add jitter: 20% random variation
                local jitter=$((base_wait / 5))
                local wait_time=$((base_wait + RANDOM % jitter))
                echo "âœ— Feed update failed, waiting ${wait_time}s before retry (base: ${base_wait}s, jitter: +$((RANDOM % jitter))s)..."
                sleep "$wait_time"
              fi
              attempt=$((attempt + 1))
            done
            
            echo "âœ— Feed update failed after $max_attempts attempts"
            return 1
          }
          
          # Function to install feeds with exponential backoff and jitter
          install_feeds_with_retry() {
            local max_attempts=10
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts: Installing feeds..."
              if ./scripts/feeds install -a; then
                echo "âœ“ Feeds installed successfully"
                return 0
              fi
              
              if [ $attempt -lt $max_attempts ]; then
                # Exponential backoff with jitter (1s, 2s, 4s, 8s, 16s, 32s, 64s, 128s, 256s)
                local base_wait=$((2 ** (attempt - 1)))
                # Add jitter: 20% random variation
                local jitter=$((base_wait / 5))
                local wait_time=$((base_wait + RANDOM % jitter))
                echo "âœ— Feed install failed, waiting ${wait_time}s before retry (base: ${base_wait}s, jitter: +$((RANDOM % jitter))s)..."
                sleep "$wait_time"
              fi
              attempt=$((attempt + 1))
            done
            
            echo "âœ— Feed install failed after $max_attempts attempts"
            return 1
          }
          
          # Update feeds with retry logic (includes cache clearing)
          update_feeds_with_retry || exit 1
          
          # Install feeds with retry logic
          install_feeds_with_retry || exit 1
          
          echo "=== Feeds updated successfully ==="

      - name: Build package with SDK
        run: |
          set -euxo pipefail
          SDK_DIR="${{ steps.sdk.outputs.sdk_dir }}"
          
          echo "=== Building package with OpenWrt SDK ==="
          cd "$SDK_DIR"
          
          # Configure for package build only
          echo "CONFIG_PACKAGE_openwrt-captive-monitor=y" >> .config
          
          # Build the package with verbose output and logging
          echo "Starting build with verbose output..."
          if ! make package/openwrt-captive-monitor/compile V=s 2>&1 | tee build.log; then
            echo "=== BUILD FAILED ==="
            echo "Build command failed"
            echo ""
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            echo ""
            echo "=== Available build logs ==="
            find . -name "*.log" -exec echo "=== {} ===" \; -exec tail -50 {} \;
            echo ""
            echo "=== Makefile errors ==="
            find . -name ".*.cmd" -exec echo "=== {} ===" \; -exec cat {} \; 2>/dev/null || true
            exit 1
          fi
          
          echo "=== Build completed successfully ==="
          echo "Build log size: $(wc -l < build.log) lines"

      - name: Find built package
        id: package
        run: |
          set -euxo pipefail
          SDK_DIR="${{ steps.sdk.outputs.sdk_dir }}"
          
          echo "=== Locating built package ==="
          
          # Find the built IPK package
          IPK_FILE=$(find "$SDK_DIR/bin/packages" -name "openwrt-captive-monitor_*.ipk" | head -n1)
          if [ -z "$IPK_FILE" ]; then
            echo "ERROR: Built IPK package not found"
            find "$SDK_DIR/bin" -type f -name "*.ipk" -ls || echo "No IPK files found"
            exit 1
          fi
          
          echo "Found IPK: $IPK_FILE"
          
          # Extract package info
          PKG_NAME=$(basename "$IPK_FILE" | sed 's/_.*//')
          PKG_VERSION=$(basename "$IPK_FILE" | sed 's/^[^_]*_\([^_]*\)_.*/\1/')
          PKG_ARCH=$(basename "$IPK_FILE" | sed 's/^[^_]*_[^_]*_\([^.]*\).*/\1/')
          
          echo "Package info:"
          echo "  Name: $PKG_NAME"
          echo "  Version: $PKG_VERSION"
          echo "  Architecture: $PKG_ARCH"
          
          # Copy to workspace for upload
          mkdir -p dist/
          cp "$IPK_FILE" dist/
          
          # Find Packages files if they exist
          PACKAGES_DIR=$(dirname "$IPK_FILE")
          if [ -f "$PACKAGES_DIR/Packages" ]; then
            cp "$PACKAGES_DIR/Packages" dist/
          fi
          if [ -f "$PACKAGES_DIR/Packages.gz" ]; then
            cp "$PACKAGES_DIR/Packages.gz" dist/
          fi
          
          {
            echo "name=$PKG_NAME"
            echo "version=$PKG_VERSION"
            echo "arch=$PKG_ARCH"
            echo "ipk=$IPK_FILE"
            echo "workspace_ipk=dist/$(basename "$IPK_FILE")"
          } >> "$GITHUB_OUTPUT"
          
          echo "=== Package location complete ==="

      - name: Validate built package
        run: |
          set -euxo pipefail
          IPK_FILE="${{ steps.package.outputs.workspace_ipk }}"
          
          echo "=== Validating built package ==="
          ./scripts/validate_ipk.sh "$IPK_FILE"
          
          echo "Package validation successful"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.package.outputs.name }}-${{ steps.package.outputs.version }}-${{ steps.package.outputs.arch }}-sdk
          path: |
            ${{ steps.package.outputs.workspace_ipk }}
            dist/Packages
            dist/Packages.gz
          retention-days: 30
          if-no-files-found: warn

      - name: Build summary
        run: |
          echo "=== OpenWrt SDK Build Summary ==="
          echo "OpenWrt Version: ${{ env.OPENWRT_VERSION }}"
          echo "Architecture: ${{ env.OPENWRT_ARCH }}"
          echo "Package: ${{ steps.package.outputs.name }}"
          echo "Version: ${{ steps.package.outputs.version }}"
          echo "Architecture: ${{ steps.package.outputs.arch }}"
          echo "IPK File: ${{ steps.package.outputs.workspace_ipk }}"
          
          if [ -f "${{ steps.package.outputs.workspace_ipk }}" ]; then
            SIZE=$(stat -c%s "${{ steps.package.outputs.workspace_ipk }}")
            echo "Package Size: $SIZE bytes"
          fi

  release:
    name: Release SDK Artifacts
    runs-on: ubuntu-latest
    needs: build-sdk
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Collect package metadata
        id: pkg
        run: |
          set -euxo pipefail
          pkg_makefile="package/openwrt-captive-monitor/Makefile"
          pkg_name=$(awk -F':=' '/^PKG_NAME:=/{gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' "$pkg_makefile")
          [ -n "$pkg_name" ] || pkg_name="openwrt-captive-monitor"
          pkg_version=$(awk -F':=' '/^PKG_VERSION:=/{gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' "$pkg_makefile")
          [ -n "$pkg_version" ] || pkg_version="0.0.0"
          pkg_release=$(awk -F':=' '/^PKG_RELEASE:=/{gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' "$pkg_makefile")
          [ -n "$pkg_release" ] || pkg_release="1"
          pkg_arch=$(awk -F':=' '/^PKG_ARCH:=/{gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' "$pkg_makefile")
          [ -n "$pkg_arch" ] || pkg_arch="all"
          {
            echo "name=$pkg_name"
            echo "version=$pkg_version"
            echo "release=$pkg_release"
            echo "arch=$pkg_arch"
          } >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ steps.pkg.outputs.name }}-${{ steps.pkg.outputs.version }}-${{ steps.pkg.outputs.release }}-${{ steps.pkg.outputs.arch }}-sdk
          path: dist/
        continue-on-error: true

      - name: Verify release artifacts
        run: |
          set -euxo pipefail
          expected_ipk="${{ steps.pkg.outputs.name }}_${{ steps.pkg.outputs.version }}-${{ steps.pkg.outputs.release }}_${{ steps.pkg.outputs.arch }}.ipk"
          if [ -f "dist/$expected_ipk" ]; then
            echo "âœ“ Found expected IPK: $expected_ipk"
            ls -la "dist/$expected_ipk"
          else
            echo "Available files in dist:"
            find dist/ -type f -ls || true
            echo "WARNING: Expected IPK not found, trying to find any IPK"
            find dist/ -name "*.ipk" -exec echo "Found: {}" \; || true
          fi
          
          if [ -f "dist/Packages" ]; then
            echo "âœ“ Found Packages index"
          fi
          
          if [ -f "dist/Packages.gz" ]; then
            echo "âœ“ Found Packages.gz index"
          fi

      - name: Validate release artifacts
        run: |
          set -euxo pipefail
          for ipk in dist/*.ipk; do
            if [ -f "$ipk" ]; then
              echo "Validating $ipk"
              ./scripts/validate_ipk.sh "$ipk"
            fi
          done

      - name: Publish SDK artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.ipk
            dist/Packages
            dist/Packages.gz
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
          body: |
            ## OpenWrt SDK-built Release
            
            This release was built using the official OpenWrt ${{ env.OPENWRT_VERSION }} SDK.
            
            ### Installation
            Download the `.ipk` file and install it on your OpenWrt device:
            ```bash
            opkg install openwrt-captive-monitor_*.ipk
            ```
            
            ### Build Information
            - **OpenWrt Version**: ${{ env.OPENWRT_VERSION }}
            - **Architecture**: ${{ env.OPENWRT_ARCH }}
            - **Build Method**: Official OpenWrt SDK
            - **Package Version**: ${{ steps.pkg.outputs.version }}-${{ steps.pkg.outputs.release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

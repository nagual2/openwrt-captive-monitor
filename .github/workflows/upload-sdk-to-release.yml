name: Upload SDK to GitHub Release

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'OpenWrt SDK version'
        required: true
        default: '23.05.3'
      force_update:
        description: 'Force update existing release'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  upload-sdk:
    name: Upload SDK to GitHub Release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Provision CLI dependencies
        uses: ./.github/actions/setup-system-packages
        with:
          packages: wget gh

      - name: Verify GitHub CLI authentication context
        run: |
          set -euo pipefail
          gh auth status --hostname github.com || gh auth login --with-token <<<"${GH_TOKEN}"

      - name: Download and upload SDK to GitHub Release
        run: |
          set -euo pipefail

          retry_with_backoff() {
            local attempt=1
            local max_attempts=5
            local wait_time=5

            while true; do
              if "$@"; then
                return 0
              fi

              if (( attempt >= max_attempts )); then
                echo "Command failed after ${attempt} attempts: $*" >&2
                return 1
              fi

              local jitter=$((RANDOM % 5))
              local sleep_for=$(( wait_time + jitter ))
              echo "Command failed (attempt ${attempt}/${max_attempts}). Retrying in ${sleep_for}s..." >&2
              sleep "${sleep_for}"
              wait_time=$(( wait_time * 2 ))
              attempt=$(( attempt + 1 ))
            done
          }

          REPO="${{ github.repository }}"
          SDK_VERSION="${{ github.event.inputs.sdk_version }}"
          SDK_FILE="openwrt-sdk-${SDK_VERSION}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          SDK_URL="https://downloads.openwrt.org/releases/${SDK_VERSION}/targets/x86/64/${SDK_FILE}"
          FORCE_UPDATE="${{ github.event.inputs.force_update }}"

          echo "üì• Downloading SDK from official mirror with exponential backoff..."
          retry_with_backoff wget -q "$SDK_URL" -O "$SDK_FILE"

          # Calculate checksum for integrity
          SHA256=$(sha256sum "$SDK_FILE" | awk '{print $1}')
          echo "‚úì SDK downloaded: $SHA256"

          # Delete existing release if force update is enabled
          if [ "$FORCE_UPDATE" = "true" ]; then
            echo "üóëÔ∏è  Deleting existing release sdk-${SDK_VERSION}..."
            retry_with_backoff gh release delete "sdk-${SDK_VERSION}" --repo "$REPO" --yes || echo "No existing release to delete"
          fi

          # Create GitHub Release
          echo "üì§ Uploading to GitHub Release..."
          RELEASE_ARGS=(
            "sdk-${SDK_VERSION}"
            "$SDK_FILE"
            --title "OpenWrt SDK ${SDK_VERSION} Mirror"
            --notes "SDK mirror for fast CI/CD builds. Checksum: $SHA256"
            --repo "$REPO"
          )
          
          if retry_with_backoff gh release create "${RELEASE_ARGS[@]}"; then
            echo "‚úÖ Release created successfully"
          else
            echo "‚ÑπÔ∏è  Release already exists, updating files..."
          fi

          # Update/create checksum file
          echo "$SHA256  $SDK_FILE" > sdk-checksum.txt
          retry_with_backoff gh release upload "sdk-${SDK_VERSION}" sdk-checksum.txt \
            --repo "$REPO" \
            --clobber

          # Get the download URL
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/sdk-${SDK_VERSION}/$SDK_FILE"
          echo "‚úÖ SDK uploaded to: $DOWNLOAD_URL"
          
          # Set output for use in other workflows
          {
            echo "download_url=$DOWNLOAD_URL"
            echo "sdk_checksum=$SHA256"
            echo "sdk_file=$SDK_FILE"
          } >> "$GITHUB_OUTPUT"

      - name: Verify upload
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          SDK_VERSION="${{ github.event.inputs.sdk_version }}"
          SDK_FILE="openwrt-sdk-${SDK_VERSION}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          
          echo "üîç Verifying uploaded SDK..."
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/sdk-${SDK_VERSION}/$SDK_FILE"
          
          # Test download with HEAD request to avoid downloading entire file
          if wget --timeout=30 --tries=3 -q --spider "$DOWNLOAD_URL"; then
            echo "‚úÖ SDK is accessible at: $DOWNLOAD_URL"
          else
            echo "‚ùå SDK verification failed - not accessible"
            exit 1
          fi
          
          # List release assets
          echo "üìã Release assets:"
          gh release view "sdk-${SDK_VERSION}" --repo "$REPO" --json assets --jq '.assets[].name'
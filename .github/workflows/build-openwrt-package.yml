name: Build OpenWrt Package

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Build OpenWrt package
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set SDK URL and paths
        run: |
          set -euo pipefail
          {
            echo "SDK_URL=https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            echo "SDK_DIR=openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64"
            echo "PACKAGE_NAME=openwrt-captive-monitor"
          } >> "$GITHUB_ENV"

      - name: Download and extract OpenWrt SDK
        run: |
          set -euo pipefail
          echo "Downloading OpenWrt SDK 23.05.3 for x86/64..."
          wget -O openwrt-sdk.tar.xz "${{ env.SDK_URL }}"
          echo "Extracting SDK..."
          tar -xf openwrt-sdk.tar.xz
          rm openwrt-sdk.tar.xz
          echo "SDK extracted to: ${{ env.SDK_DIR }}"

      - name: Sync package to SDK with clean copy strategy
        run: |
          set -euo pipefail
          SDK_DIR="${{ env.SDK_DIR }}"
          PACKAGE_DIR="$SDK_DIR/package/${{ env.PACKAGE_NAME }}"
          
          # Clean any existing package directory completely
          rm -rf "$PACKAGE_DIR"
          
          # Create fresh package directory
          mkdir -p "$PACKAGE_DIR"
          
          # Copy package contents including VERSION file and license
          cp -r package/${{ env.PACKAGE_NAME }}/* "$PACKAGE_DIR/"
          
          # Copy VERSION file to package directory
          cp VERSION "$PACKAGE_DIR/"
          
          # Copy LICENSE file to files subdirectory
          mkdir -p "$PACKAGE_DIR/files/"
          cp LICENSE "$PACKAGE_DIR/files/"
          
          echo "Package synced to SDK at: $PACKAGE_DIR"
          echo "Package contents:"
          ls -la "$PACKAGE_DIR/"
          echo "Files subdirectory contents:"
          ls -la "$PACKAGE_DIR/files/" 2>/dev/null || true

      - name: Update and install feeds
        run: |
          set -euo pipefail
          SDK_DIR="${{ env.SDK_DIR }}"
          cd "$SDK_DIR"
          
          echo "Updating feeds..."
          ./scripts/feeds update -a
          
          echo "Installing feeds..."
          ./scripts/feeds install -a
          
          echo "Feeds updated and installed successfully"

      - name: Configure SDK
        run: |
          set -euo pipefail
          SDK_DIR="${{ env.SDK_DIR }}"
          cd "$SDK_DIR"
          
          echo "Configuring SDK with defconfig..."
          make defconfig
          
          echo "SDK configuration completed"

      - name: Compile package
        run: |
          set -euo pipefail
          SDK_DIR="${{ env.SDK_DIR }}"
          cd "$SDK_DIR"
          
          echo "Compiling ${{ env.PACKAGE_NAME }} package..."
          make package/${{ env.PACKAGE_NAME }}/compile V=s
          
          echo "Package compilation completed"

      - name: Locate built package and prepare artifacts
        run: |
          set -euo pipefail
          SDK_DIR="${{ env.SDK_DIR }}"
          
          # Find the built packages directory
          PKG_DIR=$(find "$SDK_DIR/bin" -type d -name "packages" | head -n1)
          if [ -z "$PKG_DIR" ]; then
            echo "Error: Could not find packages directory"
            find "$SDK_DIR/bin" -type d | head -10
            exit 1
          fi
          
          echo "Found packages directory: $PKG_DIR"
          
          # Find the IPK file
          IPK_FILE=$(find "$PKG_DIR" -name "${{ env.PACKAGE_NAME }}_*.ipk" | head -n1)
          if [ -z "$IPK_FILE" ]; then
            echo "Error: Could not find built .ipk file"
            find "$PKG_DIR" -name "*.ipk" | head -10
            exit 1
          fi
          
          echo "Found IPK: $IPK_FILE"
          echo "IPK_FILE=$IPK_FILE" >> "$GITHUB_ENV"
          echo "IPK_NAME=$(basename "$IPK_FILE")" >> "$GITHUB_ENV"
          
          # Create artifacts directory
          mkdir -p artifacts
          cp "$IPK_FILE" artifacts/
          
          # Copy any Packages* index files if they exist
          find "$PKG_DIR" -name "Packages*" -exec cp {} artifacts/ \;
          
          # List artifacts for verification
          echo "Artifacts prepared for upload:"
          ls -la artifacts/

      - name: Validate built package
        run: |
          set -euo pipefail
          if [ -n "${{ env.IPK_FILE }}" ]; then
            echo "Validating built package..."
            ./scripts/validate_ipk.sh "${{ env.IPK_FILE }}"
            echo "Package validation successful"
          else
            echo "Error: IPK_FILE environment variable not set"
            exit 1
          fi

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-package
          path: artifacts/
          retention-days: 30
          if-no-files-found: error

      - name: Display package information
        run: |
          set -euo pipefail
          if [ -n "${{ env.IPK_FILE }}" ]; then
            echo "=== Package Information ==="
            echo "File: ${{ env.IPK_NAME }}"
            echo "Size: $(stat -c%s "${{ env.IPK_FILE }}") bytes"
            
            # Extract and display control information
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR"
            ar x "${{ env.IPK_FILE }}"
            tar -xzf control.tar.gz
            
            echo ""
            echo "=== Package Control Information ==="
            cat control
            
            rm -rf "$TEMP_DIR"
          fi
# Test merge commit

name: Tag Build Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v[0-9][0-9][0-9][0-9].[0-9]*.[0-9]*.[0-9]*'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  build-packages:
    name: Build OpenWrt Packages
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # Supported OpenWrt SDK targets for release builds (must match CI matrix)
          - openwrt_version: '23.05.5'
            target: 'x86'
            subtarget: '64'
            arch: 'x86_64'
            sdk_slug: 'x86_64'
            sdk_target: 'x86/64'
          - openwrt_version: '23.05.5'
            target: 'ath79'
            subtarget: 'generic'
            arch: 'ath79-generic'
            sdk_slug: 'ath79-generic'
            sdk_target: 'ath79/generic'
          - openwrt_version: '23.05.5'
            target: 'ramips'
            subtarget: 'mt76x8'
            arch: 'ramips-mt76x8'
            sdk_slug: 'ramips-mt76x8'
            sdk_target: 'ramips/mt76x8'
          - openwrt_version: '23.05.5'
            target: 'mediatek'
            subtarget: 'filogic'
            arch: 'mediatek-filogic'
            sdk_slug: 'mediatek-filogic'
            sdk_target: 'mediatek/filogic'
          - openwrt_version: '23.05.5'
            target: 'ipq40xx'
            subtarget: 'generic'
            arch: 'ipq40xx-generic'
            sdk_slug: 'ipq40xx-generic'
            sdk_target: 'ipq40xx/generic'
          - openwrt_version: '23.05.5'
            target: 'ipq806x'
            subtarget: 'generic'
            arch: 'ipq806x-generic'
            sdk_slug: 'ipq806x-generic'
            sdk_target: 'ipq806x/generic'
          - openwrt_version: '23.05.5'
            target: 'bcm27xx'
            subtarget: 'bcm2711'
            arch: 'bcm27xx-bcm2711'
            sdk_slug: 'bcm27xx-bcm2711'
            sdk_target: 'bcm27xx/bcm2711'
          - openwrt_version: '23.05.5'
            target: 'rockchip'
            subtarget: 'armv8'
            arch: 'rockchip-armv8'
            sdk_slug: 'rockchip-armv8'
            sdk_target: 'rockchip/armv8'

    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set build environment
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Prefer an 8-character short SHA for artifact naming consistency
          resolved_sha="${GITHUB_SHA:-}"
          if [ -z "$resolved_sha" ]; then
            resolved_sha=$(git rev-parse HEAD 2> /dev/null || echo nogit)
          fi
          short_sha=$(echo "$resolved_sha" | cut -c1-8)
          tag_name="${GITHUB_REF_NAME:-}"
          if [ -z "$tag_name" ]; then
            tag_name=$(git describe --tags --exact-match 2> /dev/null || echo "untagged")
          fi
          {
            echo "BUILD_NAME=tag-${tag_name}"
            echo "SHORT_SHA=${short_sha}"
            echo "TAG_NAME=${tag_name}"
          } >> "$GITHUB_ENV"
          echo "Using BUILD_NAME=tag-${tag_name} (sha=${short_sha})"

      - name: Prepare package structure for SDK
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Create the expected package structure for the SDK action
          mkdir -p feed/package
          cp -r package/openwrt-captive-monitor feed/package/
          # Create artifacts directory
          mkdir -p "artifacts/${BUILD_NAME}"

          # Ensure a placeholder feeds.conf.default exists for the SDK action to patch
          # The openwrt/gh-action-sdk action expects this file under FEED_DIR and will
          # inject the local src-link feed path at runtime. Upstream feeds are not required
          # for this package build.
          if [ ! -f feed/feeds.conf.default ]; then
            {
              echo "# Placeholder feeds.conf.default for SDK action"
              echo "# The action will inject: src-link ${FEEDNAME:-local} <resolved-path>"
            } > feed/feeds.conf.default
          fi

          echo "Prepared package structure:"
          find feed -type f -name "Makefile" | head -5

      - name: Validate SDK image and target
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ./scripts/validate-sdk-image.sh \
            "ghcr.io/openwrt/sdk:${{ matrix.sdk_slug }}-${{ matrix.openwrt_version }}" \
            "${{ matrix.sdk_target }}" \
            "${{ matrix.openwrt_version }}" \
            "${{ matrix.sdk_slug }}"

      - name: Build with OpenWrt SDK (${{ matrix.sdk_target }})
        uses: openwrt/gh-action-sdk@v9
        env:
          # Use the official SDK container pinned to the OpenWrt version and target
          # e.g., x86-64-23.05.5
          ARCH: ${{ matrix.sdk_slug }}-${{ matrix.openwrt_version }}
          # Package(s) to build inside the SDK
          PACKAGES: openwrt-captive-monitor
          BUILD_LOG: 1
          V: s
          # Feed configuration - use default feeds plus our local feed
          FEEDNAME: local
          # Mount points for the action
          ARTIFACTS_DIR: ${{ github.workspace }}/artifacts/${{ env.BUILD_NAME }}
          FEED_DIR: ${{ github.workspace }}/feed

      - name: List and validate produced artifacts
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ART_DIR="${{ env.ARTIFACTS_DIR }}"
          echo "Artifacts directory: $ART_DIR"

          if [ ! -d "$ART_DIR" ]; then
            echo "ERROR: Artifact directory not found: $ART_DIR"
            exit 1
          fi

          ls -la "$ART_DIR"
          echo "IPK files:"

          # Robust IPK discovery with quoted paths and existence checks
          IPK_COUNT=0

          # Top-level .ipk files
          for ipk in "$ART_DIR"/*.ipk; do
            [ -e "$ipk" ] || continue
            basename "$ipk"
            IPK_COUNT=$((IPK_COUNT + 1))
          done

          # One-level-deep .ipk files
          for dir in "$ART_DIR"/*; do
            [ -e "$dir" ] || continue
            for f in "$dir"/*.ipk; do
              [ -e "$f" ] || continue
              basename "$f"
              IPK_COUNT=$((IPK_COUNT + 1))
            done
          done

          if [ "$IPK_COUNT" -eq 0 ]; then
            echo "error: no .ipk files found in $ART_DIR" >&2
            exit 1
          fi

      - name: Setup opkg-utils
        run: sh ./scripts/setup-opkg-utils.sh

      - name: Install verification tools
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar

      - name: Verify package internals
        env:
          ARTIFACTS_DIR: ${{ github.workspace }}/artifacts/${{ env.BUILD_NAME }}
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Robust IPK discovery with quoted paths and existence checks
          IPK_FILE=""
          for ipk_pattern in "${{ env.ARTIFACTS_DIR }}"/openwrt-captive-monitor_*.ipk; do
            if [ -e "$ipk_pattern" ]; then
              IPK_FILE="$ipk_pattern"
              break
            fi
          done

          if [ -z "$IPK_FILE" ]; then
            echo "error: no openwrt-captive-monitor package found" >&2
            exit 1
          fi
          echo "Verifying package: $IPK_FILE"
          ./scripts/verify_package.sh "$IPK_FILE"

      - name: Validate IPK version metadata
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          echo "=== Validating Version field in .ipk control metadata ==="
          for IPK_FILE in "${{ env.ARTIFACTS_DIR }}"/*.ipk; do
            if [ ! -e "$IPK_FILE" ]; then
              echo "warning: no .ipk files found" >&2
              continue
            fi
            echo ""
            echo "Validating: $(basename "$IPK_FILE")"
            ./scripts/validate-ipk-version.sh "$IPK_FILE" "release"
          done
          echo ""
          echo "All packages validated successfully"

      - name: Stage package artifacts with SHA256SUMS
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ./scripts/stage-package-artifacts.sh "${{ env.ARTIFACTS_DIR }}"

      - name: Upload package artifacts
        uses: actions/upload-artifact@v5
        with:
          name: captive-monitor-${{ matrix.sdk_target }}+${{ env.SHORT_SHA }}
          path: package
          retention-days: 30
          if-no-files-found: error
          compression-level: 6

      - name: Build summary
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          {
            echo "## ðŸ“¦ Build Summary"
            echo ""
            echo "**Tag:** ${{ env.TAG_NAME }}"
            echo "**Target:** ${{ matrix.sdk_target }}"
            echo "**Architecture:** ${{ matrix.arch }}"
            echo "**OpenWrt Version:** ${{ matrix.openwrt_version }}"
            echo "**Short SHA:** ${{ env.SHORT_SHA }}"
            echo ""
            echo "### ðŸ“‹ Generated Packages"
            find "artifacts/${BUILD_NAME}" -name "*.ipk" -exec echo "- {}" \;
          } >> "$GITHUB_STEP_SUMMARY"

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-24.04
    needs: build-packages
    permissions:
      contents: write

    steps:
      - name: Download package artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Prepare aggregated package directory
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi

          ARTIFACTS_ROOT="artifacts"

          if [ ! -d "$ARTIFACTS_ROOT" ]; then
            echo "âŒ artifacts directory not found at $ARTIFACTS_ROOT"
            ls -la
            exit 1
          fi

          mkdir -p package
          ipk_count=0

          for dir in "$ARTIFACTS_ROOT"/*; do
            [ -d "$dir" ] || continue
            echo "Processing artifacts from $dir"
            for ipk in "$dir"/*.ipk; do
              [ -f "$ipk" ] || continue
              cp -v "$ipk" package/
              ipk_count=$((ipk_count + 1))
            done
          done

          if [ "$ipk_count" -eq 0 ]; then
            echo "âŒ no .ipk files found under $ARTIFACTS_ROOT" >&2
            find "$ARTIFACTS_ROOT" -maxdepth 2 -type f | sed 's/^/  - /'
            exit 1
          fi

          echo "Aggregated $ipk_count .ipk file(s) into package/"

          cd package
          if command -v sha256sum > /dev/null 2>&1; then
            sha256sum ./*.ipk > SHA256SUMS
          elif command -v shasum > /dev/null 2>&1; then
            shasum -a 256 ./*.ipk > SHA256SUMS
          else
            echo "âŒ neither sha256sum nor shasum found" >&2
            exit 1
          fi

          echo "Generated SHA256SUMS:"
          cat SHA256SUMS

      - name: Install GitHub CLI
        uses: ./.github/actions/setup-system-packages
        with:
          packages: gh

      - name: Create or update GitHub Release with package assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi

          TAG="${GITHUB_REF_NAME:-}"
          if [ -z "$TAG" ]; then
            echo "âŒ Unable to determine tag name from GITHUB_REF_NAME"
            exit 1
          fi

          if ! ls package/*.ipk > /dev/null 2>&1; then
            echo "âŒ No .ipk files found in package/; refusing to create an empty release"
            exit 1
          fi

          # Create the release if it does not already exist
          RELEASE_ID=$(gh release view "$TAG" --json id --jq '.id' 2> /dev/null || echo "")
          if [ -z "$RELEASE_ID" ]; then
            echo "â„¹ï¸  Creating GitHub Release for tag $TAG"
            gh release create "$TAG" \
              --title "$TAG" \
              --notes "Automated release for $TAG" \
              --latest
          else
            echo "â„¹ï¸  GitHub Release for tag $TAG already exists (id=$RELEASE_ID); uploading assets"
          fi

          echo "Uploading package assets (.ipk and SHA256SUMS) to release $TAG"
          files=(package/*.ipk)
          if [ -f package/SHA256SUMS ]; then
            files+=(package/SHA256SUMS)
          fi
          printf '  + %s\n' "${files[@]}"
          gh release upload "$TAG" "${files[@]}" --clobber

      - name: Release summary
        run: |
          TAG="${GITHUB_REF_NAME:-}"
          {
            echo "## Release summary"
            echo ""
            echo "Tag: $TAG"
            echo "Attached assets:"
            ls -1 package
          } >> "$GITHUB_STEP_SUMMARY"

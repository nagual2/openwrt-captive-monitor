name: Build OpenWrt packages

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'fix/*'
      - 'chore/*'
      - 'docs/*'
      - 'hotfix/*'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  build:
    name: Build (${{ matrix.target_id }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: ath79
            subtarget: generic
            target_id: ath79-generic
            arch_packages: mips_24kc
          - target: ramips
            subtarget: mt7621
            target_id: ramips-mt7621
            arch_packages: mipsel_24kc
    env:
      OPENWRT_VERSION: "23.05.5"
      PACKAGE_NAME: "openwrt-captive-monitor"
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.1.7

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            rsync \
            unzip \
            zlib1g-dev \
            file \
            wget \
            xz-utils \
            python3 \
            python3-dev

      - name: Download OpenWrt SDK
        id: sdk
        shell: bash
        run: |
          set -euxo pipefail
          TARGET="${{ matrix.target }}"
          SUBTARGET="${{ matrix.subtarget }}"
          SDK_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${TARGET}/${SUBTARGET}/"

          echo "Checking SDK URL: $SDK_URL"
          SDK_PAGE=$(curl -fsSL "$SDK_URL" || echo "FAILED")

          if [ "$SDK_PAGE" = "FAILED" ]; then
            echo "Primary SDK URL failed, trying alternative versions..."
            # Try alternative versions
            for version in "23.05.4" "23.05.3" "23.05.2"; do
              echo "Trying version $version..."
              ALT_SDK_URL="https://downloads.openwrt.org/releases/$version/targets/${TARGET}/${SUBTARGET}/"
              SDK_PAGE=$(curl -fsSL "$ALT_SDK_URL" 2>/dev/null || echo "FAILED")
              if [ "$SDK_PAGE" != "FAILED" ]; then
                SDK_URL="$ALT_SDK_URL"
                OPENWRT_VERSION="$version"
                echo "Found working SDK at version $version"
                break
              fi
            done
          fi

          if [ "$SDK_PAGE" = "FAILED" ]; then
            echo "No working SDK found for target ${TARGET}/${SUBTARGET}"
            echo "Available releases:"
            curl -fsSL "https://downloads.openwrt.org/releases/" | grep -oE 'href="[0-9]+\.[0-9]+\.[0-9]+/"' | head -10 || echo "Cannot list releases"
            exit 1
          fi

          SDK_TARBALL=$(echo "$SDK_PAGE" | grep -oE 'openwrt-sdk-[^"]*\.tar\.xz' | head -n1)
          if [ -z "$SDK_TARBALL" ]; then
            echo "No SDK tarball found on page"
            echo "Page content preview:"
            echo "$SDK_PAGE" | head -20
            exit 1
          fi

          echo "Downloading SDK: $SDK_TARBALL"
          curl -fSLo "$SDK_TARBALL" "${SDK_URL}${SDK_TARBALL}"

          if [ ! -f "$SDK_TARBALL" ]; then
            echo "SDK download failed"
            exit 1
          fi

          tar -xf "$SDK_TARBALL"
          set +o pipefail; SDK_DIR=$(tar -tf "$SDK_TARBALL" | head -n1 | cut -d/ -f1) || true; set -o pipefail

          if [ -z "$SDK_DIR" ]; then
            echo "Cannot determine SDK directory"
            tar -tf "$SDK_TARBALL" | head -5
            exit 1
          fi

          echo "dir=$SDK_DIR" >> "$GITHUB_OUTPUT"
          echo "SDK extracted to: $SDK_DIR"

      - name: Build package
        shell: bash
        run: |
          set -euxo pipefail
          SDK_DIR="${{ steps.sdk.outputs.dir }}"
          TARGET="${{ matrix.target }}"
          SUBTARGET="${{ matrix.subtarget }}"
          TARGET_ID="${{ matrix.target_id }}"
          TARGET_PREFIX="${TARGET}-${SUBTARGET}"
          PACKAGE_NAME="${{ env.PACKAGE_NAME }}"

          # Build package
          pushd "$SDK_DIR"
          export TERM=dumb
          ./scripts/feeds update -a && ./scripts/feeds install -a

          # Create config
          cat <<EOF > .config
          CONFIG_TARGET_${TARGET}=y
          CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
          CONFIG_TARGET_MULTI_PROFILE=y
          CONFIG_ALL=n
          CONFIG_ALL_KMODS=n
          CONFIG_PACKAGE_${PACKAGE_NAME}=m
          EOF

          make defconfig
          make V=sc -j"$(nproc)" package/${PACKAGE_NAME}/compile
          make V=s package/index
          popd

          # Prepare artifacts
          ARCH="${{ matrix.arch_packages }}"
          ARTIFACT_DIR="$GITHUB_WORKSPACE/artifacts/$TARGET_ID"
          mkdir -p "$ARTIFACT_DIR"

          # Find and copy packages (simplified)
          find "$SDK_DIR/bin/packages" -name "*${PACKAGE_NAME}*.ipk" -exec cp {} "$ARTIFACT_DIR/" \;

          # Check if packages were found
          if [ ! -f "$ARTIFACT_DIR"/*.ipk ]; then
            echo "No packages found!"
            find "$SDK_DIR/bin" -name "*.ipk" || true
            exit 1
          fi

          echo "Build completed successfully"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4.3.3
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ matrix.target_id }}
          path: artifacts/${{ matrix.target_id }}
          if-no-files-found: error
          retention-days: 7

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.7
        with:
          path: release-artifacts

      - name: Publish release assets
        uses: softprops/action-gh-release@v2.4.1
        with:
          files: |
            release-artifacts/**/*.ipk
            release-artifacts/**/*Packages*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



name: Lint

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'fix/*'
      - 'chore/*'
      - 'docs/*'
      - 'hotfix/*'
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  lint:
    name: Shell lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.1.7

      - name: Install lint dependencies
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      - name: Determine shell script targets
        id: targets
        run: |
          set -euo pipefail
          mapfile -d '' -t files < <(
            git ls-files -z \
              '*.sh' \
              'init.d/*' \
              'package/openwrt-captive-monitor/files/usr/sbin/openwrt_captive_monitor' \
              'package/openwrt-captive-monitor/files/etc/init.d/*' \
              'package/openwrt-captive-monitor/files/etc/uci-defaults/*' \
              'scripts/*.sh'
          )
          if [ "${#files[@]}" -eq 0 ]; then
            echo "count=0" >> "$GITHUB_OUTPUT"
          else
            printf '%s\0' "${files[@]}" > shell-files.txt
            echo "count=${#files[@]}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run shfmt
        if: steps.targets.outputs.count != '0'
        run: |
          set -euo pipefail
          shfmt_args=()
          while IFS= read -r line; do
            shfmt_args+=("$line")
          done < <(grep -Ev '^\s*(#|$)' .shfmt.conf || true)
          if [ "${#shfmt_args[@]}" -eq 0 ]; then
            shfmt_args=(-i=4 -ci -sr -ln=posix)
          fi
          mapfile -d '' -t files < shell-files.txt
          shfmt "${shfmt_args[@]}" -d "${files[@]}"

      - name: Run ShellCheck
        if: steps.targets.outputs.count != '0'
        run: |
          set -euo pipefail
          mapfile -d '' -t files < shell-files.txt
          shellcheck "${files[@]}"

      - name: Validate init scripts are POSIX-parseable
        run: |
          set -euo pipefail
          sh -n init.d/captive-monitor
          sh -n package/openwrt-captive-monitor/files/usr/sbin/openwrt_captive_monitor
          sh -n package/openwrt-captive-monitor/files/etc/init.d/captive-monitor
          sh -n package/openwrt-captive-monitor/files/etc/uci-defaults/99-captive-monitor

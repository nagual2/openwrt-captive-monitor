name: Lint

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Go toolchain (for shfmt)
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install shfmt
        run: |
          go install mvdan.cc/sh/v3/cmd/shfmt@v3.8.0
          echo "${HOME}/go/bin" >> "${GITHUB_PATH}"

      - name: Run shfmt (no changes expected)
        run: |
          shfmt -i 2 -ci -sr -d \
            openwrt_captive_monitor.sh \
            init.d/captive-monitor \
            package/openwrt-captive-monitor/files/usr/sbin/openwrt_captive_monitor \
            scripts/build_ipk.sh

      - name: Run ShellCheck (-s sh)
        run: |
          shellcheck -s sh \
            openwrt_captive_monitor.sh \
            init.d/captive-monitor \
            package/openwrt-captive-monitor/files/usr/sbin/openwrt_captive_monitor \
            scripts/build_ipk.sh

      - name: Validate installed init script syntax
        run: |
          sh -n package/openwrt-captive-monitor/files/etc/init.d/captive-monitor

name: Lint

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'fix/*'
      - 'chore/*'
      - 'docs/*'
      - 'hotfix/*'
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  lint:
    name: Shell lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.1.7

      - name: Install lint dependencies
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      - name: Determine shell script targets
        id: targets
        shell: bash
        run: |
          set -euo pipefail

          # Simple approach: check all known shell script files
          shell_files=(
            "scripts/build_ipk.sh"
            "test_captive_monitor.sh"
            "test_captive_scenarios.sh"
            "init.d/captive-monitor"
            "openwrt_captive_monitor.sh"
            "package/openwrt-captive-monitor/files/usr/sbin/openwrt_captive_monitor"
            "package/openwrt-captive-monitor/files/etc/init.d/captive-monitor"
            "package/openwrt-captive-monitor/files/etc/uci-defaults/99-captive-monitor"
          )

          valid_files=()
          for file in "${shell_files[@]}"; do
            if [ -f "$file" ] && head -n 1 "$file" 2>/dev/null | grep -qE '^#!/.*sh\b'; then
              valid_files+=("$file")
            fi
          done

          if [ ${#valid_files[@]} -gt 0 ]; then
            printf '%s\n' "${valid_files[@]}" > shell-files.txt
            echo "count=${#valid_files[@]}" >> "$GITHUB_OUTPUT"
          else
            echo "count=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Run shfmt
        if: steps.targets.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          shfmt_args=()
          while IFS= read -r line; do
            shfmt_args+=("$line")
          done < <(grep -Ev '^\s*(#|$)' .shfmt.conf || true)
          if [ ${#shfmt_args[@]} -eq 0 ]; then
            shfmt_args=(-i=4 -ci -sr -ln=posix)
          fi
          # Read files from shell-files.txt (one per line)
          files=()
          while IFS= read -r line; do
            [ -n "$line" ] && files+=("$line")
          done < shell-files.txt
          shfmt "${shfmt_args[@]}" -d "${files[@]}"

      - name: Run ShellCheck
        if: steps.targets.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          # Read files from shell-files.txt (one per line)
          files=()
          while IFS= read -r line; do
            [ -n "$line" ] && files+=("$line")
          done < shell-files.txt
          shellcheck "${files[@]}"

      - name: Validate init scripts are POSIX-parseable
        shell: bash
        run: |
          set -euo pipefail
          sh -n init.d/captive-monitor
          sh -n openwrt_captive_monitor.sh
          sh -n scripts/build_ipk.sh
          sh -n test_captive_monitor.sh
          sh -n test_captive_scenarios.sh
          sh -n package/openwrt-captive-monitor/files/usr/sbin/openwrt_captive_monitor
          sh -n package/openwrt-captive-monitor/files/etc/init.d/captive-monitor
          sh -n package/openwrt-captive-monitor/files/etc/uci-defaults/99-captive-monitor

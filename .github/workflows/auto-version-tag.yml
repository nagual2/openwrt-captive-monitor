name: Auto Version Tag and Release

on:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  tag-and-release:
    name: Create Version Tag and Release
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check for auto-version skip sentinel
        id: auto-version-skip
        run: |
          set -euo pipefail

          COMMIT_MSG=$(git log -1 --pretty=%B || echo "")

          if echo "$COMMIT_MSG" | grep -q '\[skip-auto-version\]'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Detected [skip-auto-version] sentinel in commit message; skipping auto version tagging."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "No [skip-auto-version] sentinel found; proceeding with auto version tagging."
          fi

      - name: Configure Git
        if: steps.auto-version-skip.outputs.skip != 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Determine next version
        if: steps.auto-version-skip.outputs.skip != 'true'
        id: version
        run: |
          set -euo pipefail

          git fetch --tags --force

          YEAR=$(date -u +%Y)
          MONTH=$(date -u +%-m)
          DAY=$(date -u +%-d)
          DATE_PREFIX="v${YEAR}.${MONTH}.${DAY}"

          LAST_SEQUENCE=$(git tag --list "${DATE_PREFIX}.*" | sed -nE "s/^${DATE_PREFIX}\.([0-9]+)$/\1/p" | sort -n | tail -n1)
          if [ -z "$LAST_SEQUENCE" ]; then
            NEXT_SEQUENCE=1
          else
            NEXT_SEQUENCE=$((LAST_SEQUENCE + 1))
          fi

          NEW_TAG="${DATE_PREFIX}.${NEXT_SEQUENCE}"

          # Only consider date-based release tags (vYYYY.MM.DD.N) when determining the previous tag
          PREVIOUS_TAG=$(git tag --list 'v[0-9][0-9][0-9][0-9].[0-9]*.[0-9]*.[0-9]*' --sort=-creatordate | grep -Fvx "$NEW_TAG" | head -n1 || true)

          echo "Calculated new tag: $NEW_TAG"
          echo "Previous tag: ${PREVIOUS_TAG:-<none>}"

          {
            echo "version=$NEW_TAG"
            echo "sequence=$NEXT_SEQUENCE"
            echo "previous_tag=$PREVIOUS_TAG"
          } >> "$GITHUB_OUTPUT"

      - name: Update version metadata and commit changes
        if: steps.auto-version-skip.outputs.skip != 'true'
        id: update-metadata
        run: |
          set -euo pipefail

          NEW_TAG="${{ steps.version.outputs.version }}"
          CLEAN_VERSION="${NEW_TAG#v}"

          echo "New tag: $NEW_TAG"
          echo "Clean version: $CLEAN_VERSION"

          # Update VERSION and PKG_VERSION metadata in the working tree
          ./scripts/update-version-metadata.sh "$CLEAN_VERSION"

          # Check if there are any changes to commit
          if git diff --quiet --exit-code VERSION package/openwrt-captive-monitor/Makefile; then
            echo "No metadata changes detected; skipping commit."
            {
              echo "updated=false"
              echo "clean_version=$CLEAN_VERSION"
              echo "commit_sha=$(git rev-parse HEAD)"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Staging VERSION and package Makefile changes..."
          git add VERSION package/openwrt-captive-monitor/Makefile

          COMMIT_MESSAGE="chore: bump version to $CLEAN_VERSION [skip-auto-version]"
          echo "Creating commit: $COMMIT_MESSAGE"
          git commit -m "$COMMIT_MESSAGE"

          echo "Pushing metadata bump commit to main..."
          git push origin HEAD:main

          # Capture the SHA of the version bump commit for tagging
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "Version bump commit SHA: $COMMIT_SHA"

          {
            echo "updated=true"
            echo "clean_version=$CLEAN_VERSION"
            echo "commit_sha=$COMMIT_SHA"
          } >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        if: steps.auto-version-skip.outputs.skip != 'true'
        id: notes
        run: |
          set -euo pipefail

          NEW_TAG="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.version.outputs.previous_tag }}"

          NOTES_FILE="release-notes-${NEW_TAG}.md"

          {
            echo "## Release $NEW_TAG"
            echo ""
            echo "Generated on $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo ""
          } > "$NOTES_FILE"

          if [ -n "$PREVIOUS_TAG" ]; then
            RANGE="${PREVIOUS_TAG}..HEAD"
            echo "Changes since $PREVIOUS_TAG:" >> "$NOTES_FILE"
          else
            RANGE="HEAD"
            echo "Changes since repository inception:" >> "$NOTES_FILE"
          fi

          echo "" >> "$NOTES_FILE"

          COMMITS=$(git log "$RANGE" --pretty=format:'- %s' --reverse || true)
          if [ -z "$COMMITS" ]; then
            echo "- No new commits found." >> "$NOTES_FILE"
          else
            printf '%s\n' "$COMMITS" >> "$NOTES_FILE"
          fi

          echo "" >> "$NOTES_FILE"

          echo "=== Release notes ==="
          cat "$NOTES_FILE"
          echo "====================="

          echo "file=$NOTES_FILE" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists
        if: steps.auto-version-skip.outputs.skip != 'true'
        id: tag-check
        run: |
          set -euo pipefail

          NEW_TAG="${{ steps.version.outputs.version }}"

          if git rev-parse -q --verify "refs/tags/$NEW_TAG" >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag $NEW_TAG already exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Tag $NEW_TAG does not exist yet"
          fi

      - name: Create and push tag
        if: steps.auto-version-skip.outputs.skip != 'true' && steps.tag-check.outputs.exists == 'false'
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set -euo pipefail

          NEW_TAG="${{ steps.version.outputs.version }}"
          COMMIT_SHA="${{ steps.update-metadata.outputs.commit_sha }}"

          echo "Creating tag $NEW_TAG on commit $COMMIT_SHA"

          # Create tag on the specific commit SHA (version bump commit)
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG" "$COMMIT_SHA"
          
          # Use PAT if available to trigger downstream workflows
          if [ -n "${PAT_TOKEN:-}" ]; then
            echo "Using PAT_TOKEN to push tag..."
            git push "https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}.git" "$NEW_TAG"
          else
            echo "PAT_TOKEN not found, falling back to origin push (no downstream trigger)..."
            git push origin "$NEW_TAG"
          fi

      - name: Check release status
        if: steps.auto-version-skip.outputs.skip != 'true'
        id: release-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          NEW_TAG="${{ steps.version.outputs.version }}"

          if gh release view "$NEW_TAG" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release $NEW_TAG already exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release $NEW_TAG does not exist"
          fi

      - name: Create GitHub release
        if: steps.auto-version-skip.outputs.skip != 'true' && steps.release-check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          NEW_TAG="${{ steps.version.outputs.version }}"
          NOTES_FILE="${{ steps.notes.outputs.file }}"

          gh release create "$NEW_TAG" \
            --title "$NEW_TAG" \
            --notes-file "$NOTES_FILE"

      - name: Summarize run
        if: steps.auto-version-skip.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.version.outputs.previous_tag }}"
          SEQUENCE="${{ steps.version.outputs.sequence }}"
          TAG_EXISTS="${{ steps.tag-check.outputs.exists }}"
          RELEASE_EXISTS="${{ steps.release-check.outputs.exists }}"
          METADATA_UPDATED="${{ steps.update-metadata.outputs.updated }}"
          CLEAN_VERSION="${{ steps.update-metadata.outputs.clean_version }}"

          {
            echo "## Auto version summary"
            echo ""
            echo "- Version: $VERSION"
            echo "- Previous tag: ${PREVIOUS_TAG:-N/A}"
            echo "- Sequence for today: $SEQUENCE"
            echo "- Tag existed before run: $TAG_EXISTS"
            echo "- Release existed before run: $RELEASE_EXISTS"
            echo "- Clean version (VERSION/PKG_VERSION): ${CLEAN_VERSION:-N/A}"
            echo "- Metadata updated in this run: ${METADATA_UPDATED:-false}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Summarize skipped run
        if: steps.auto-version-skip.outputs.skip == 'true'
        run: |
          {
            echo "## Auto version summary"
            echo ""
            echo "- Auto versioning was skipped because the commit message contained [skip-auto-version]."
          } >> "$GITHUB_STEP_SUMMARY"

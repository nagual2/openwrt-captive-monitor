name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    strategy:
      matrix:
        linter:
          - shfmt
          - shellcheck
          - markdownlint
          - actionlint
          - yamllint

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Install base dependencies
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar

      - name: Install linter dependencies
        if: matrix.linter == 'shfmt' || matrix.linter == 'shellcheck'
        uses: ./.github/actions/setup-system-packages
        with:
          packages: busybox shfmt shellcheck

      - name: Set up Node.js 20
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Show Node.js version
        run: node --version

      - name: Install yamllint
        if: matrix.linter == 'yamllint'
        uses: ./.github/actions/setup-system-packages
        with:
          packages: yamllint

      - name: Run yamllint
        if: matrix.linter == 'yamllint'
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          yamllint -d "{extends: relaxed, rules: {truthy: disable}}" \
            .github/workflows/ci.yml

      - name: Run shfmt
        if: matrix.linter == 'shfmt'
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          shfmt -d -s -i 4 -ci -sr .

      - name: Run shellcheck
        if: matrix.linter == 'shellcheck'
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          find . -type f -name "*.sh" -exec shellcheck {} +
          shellcheck openwrt_captive_monitor.sh

      - name: Run markdownlint
        if: matrix.linter == 'markdownlint'
        uses: DavidAnson/markdownlint-cli2-action@v21
        with:
          config: '.markdownlint.json'
          files: '**/*.md'

      - name: Run actionlint
        if: matrix.linter == 'actionlint'
        uses: reviewdog/action-actionlint@v1
        with:
          fail_level: error

  test:
    name: Test
    runs-on: ubuntu-24.04
    needs: lint
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Install test dependencies
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar busybox

      - name: Run test harness with BusyBox ash
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          busybox ash tests/run.sh

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results
          path: tests/_out/
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  build-dev-package:
    name: Build Dev Package
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Supported OpenWrt SDK targets for CI package builds
          - openwrt_version: '23.05.5'
            target: 'x86'
            subtarget: '64'
            arch: 'x86_64'
            sdk_slug: 'x86_64'
            sdk_target: 'x86/64'
          - openwrt_version: '23.05.5'
            target: 'ath79'
            subtarget: 'generic'
            arch: 'ath79-generic'
            sdk_slug: 'ath79-generic'
            sdk_target: 'ath79/generic'
          - openwrt_version: '23.05.5'
            target: 'ramips'
            subtarget: 'mt76x8'
            arch: 'ramips-mt76x8'
            sdk_slug: 'ramips-mt76x8'
            sdk_target: 'ramips/mt76x8'
          - openwrt_version: '23.05.5'
            target: 'mediatek'
            subtarget: 'filogic'
            arch: 'mediatek-filogic'
            sdk_slug: 'mediatek-filogic'
            sdk_target: 'mediatek/filogic'
          - openwrt_version: '23.05.5'
            target: 'ipq40xx'
            subtarget: 'generic'
            arch: 'ipq40xx-generic'
            sdk_slug: 'ipq40xx-generic'
            sdk_target: 'ipq40xx/generic'
          - openwrt_version: '23.05.5'
            target: 'ipq806x'
            subtarget: 'generic'
            arch: 'ipq806x-generic'
            sdk_slug: 'ipq806x-generic'
            sdk_target: 'ipq806x/generic'
          - openwrt_version: '23.05.5'
            target: 'bcm27xx'
            subtarget: 'bcm2711'
            arch: 'bcm27xx-bcm2711'
            sdk_slug: 'bcm27xx-bcm2711'
            sdk_target: 'bcm27xx/bcm2711'
          - openwrt_version: '23.05.5'
            target: 'rockchip'
            subtarget: 'armv8'
            arch: 'rockchip-armv8'
            sdk_slug: 'rockchip-armv8'
            sdk_target: 'rockchip/armv8'
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set build environment
        id: build-env
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Prefer an 8-character short SHA for artifact naming consistency
          resolved_sha="${GITHUB_SHA:-}"
          if [ -z "$resolved_sha" ]; then
            resolved_sha=$(git rev-parse HEAD 2> /dev/null || echo nogit)
          fi
          short_sha=$(echo "$resolved_sha" | cut -c1-8)
          {
            echo "BUILD_NAME=main"
            echo "SHORT_SHA=${short_sha}"
          } >> "$GITHUB_ENV"
          echo "Using BUILD_NAME=main (artifact suffix: +${short_sha})"

      - name: Prepare package structure for SDK
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Create the expected package structure for the SDK action
          mkdir -p feed/package
          cp -r package/openwrt-captive-monitor feed/package/
          # Create artifacts directory
          mkdir -p "artifacts/${BUILD_NAME}"

          # Ensure a placeholder feeds.conf.default exists for the SDK action to patch
          # The openwrt/gh-action-sdk action expects this file under FEED_DIR and will
          # inject the local src-link feed path at runtime. Upstream feeds are not required
          # for this package build.
          if [ ! -f feed/feeds.conf.default ]; then
            {
              echo "# Placeholder feeds.conf.default for SDK action"
              echo "# The action will inject: src-link ${FEEDNAME:-local}" \
                "<resolved-path>"
            } > feed/feeds.conf.default
          fi

          echo "Prepared package structure:"
          find feed -type f -name "Makefile" | head -5

      - name: Validate SDK image and target
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ./scripts/validate-sdk-image.sh \
            "ghcr.io/openwrt/sdk:${{ matrix.sdk_slug }}-${{ matrix.openwrt_version }}" \
            "${{ matrix.sdk_target }}" \
            "${{ matrix.openwrt_version }}" \
            "${{ matrix.sdk_slug }}"

      - name: Cache OpenWrt SDK
        uses: actions/cache@v4
        with:
          path: sdk.tar.xz
          key: openwrt-sdk-${{ matrix.openwrt_version }}-${{ matrix.sdk_slug }}
          restore-keys: |
            openwrt-sdk-${{ matrix.openwrt_version }}-

      - name: Download OpenWrt SDK
        run: |
          set -eu
          # Construct SDK URL based on matrix variables
          # URL format:
          # https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          # We need to dynamically determine the GCC/musl version part which is tricky.
          # However, the 'openwrt/gh-action-sdk' does this internally.
          # For manual steps, it's safer to use the 'sdk-simple-build.yml' approach
          # but generalized.

          # Actually, the SDK URL varies by target.
          # Let's use a helper script or just use the same logic as the simple build
          # but adapted for matrix.
          # Since we have many targets, we need a robust way to get the SDK.
          # The 'openwrt/gh-action-sdk' uses a Docker container.
          # We can emulate that by running the build INSIDE the official SDK container
          # directly using 'jobs.<job_id>.container'.
          # BUT 'jobs.<job_id>.container' doesn't support matrix variables easily for
          # the image name.

          # Alternative: Use the 'Download OpenWrt SDK' step pattern from
          # 'sdk-simple-build.yml' but we need the exact URL.
          # The URL depends on the target.

          # Let's try to use the 'openwrt/gh-action-sdk' container image but run
          # MANUAL commands inside it?
          # No, the action entrypoint is fixed.

          # Let's stick to the plan: Use manual steps.
          # We need to download the SDK.
          # We can use 'find' to locate the .ipk file.
          # No, that's complex.

          # Let's look at how 'sdk-simple-build.yml' does it:
          # SDK_URL="https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"

          # We need this for all targets.
          # We can add 'sdk_url_part' to the matrix? Or just 'sdk_name'.
          # The matrix already has 'sdk_slug'.

          # Let's look at the matrix again.
          # x86/64 -> openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          # ramips/mt76x8 -> openwrt-sdk-23.05.5-ramips-mt76x8_gcc-12.3.0_musl.Linux-x86_64.tar.xz

          # The suffix `_gcc-12.3.0_musl.Linux-x86_64.tar.xz` is constant for
          # 23.05.5 on x86_64 host?
          # Yes, usually.

          # Let's try to construct the URL dynamically.
          # Base:
          # https://downloads.openwrt.org/releases/${{ matrix.openwrt_version }}/targets/${{ matrix.target }}/${{ matrix.subtarget }}/
          # File:
          # openwrt-sdk-${{ matrix.openwrt_version }}-${{ matrix.sdk_slug }}_gcc-12.3.0_musl.Linux-x86_64.tar.xz

          # Wait, 'sdk_slug' for x86/64 is 'x86-64'.
          # File is 'openwrt-sdk-23.05.5-x86-64_...'

          # Let's assume the suffix is constant for 23.05.5.
          # If not, we might fail.

          SDK_FILE="openwrt-sdk-${{ matrix.openwrt_version }}-${{ matrix.sdk_slug }}_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          SDK_URL="https://downloads.openwrt.org/releases/${{ matrix.openwrt_version }}/targets/${{ matrix.target }}/${{ matrix.subtarget }}/${SDK_FILE}"

          if [ ! -f sdk.tar.xz ]; then
            echo "Downloading SDK from $SDK_URL"
            curl -fsSL "$SDK_URL" -o sdk.tar.xz
          else
            echo "Using cached SDK"
          fi
          mkdir -p sdk
          tar -C sdk --strip-components=1 -xf sdk.tar.xz

      - name: Build Package (Manual)
        run: |
          set -eu
          cd sdk

          # Setup feed
          FEED_DIR="${{ github.workspace }}/feed"
          # We prepared 'feed/package' in the previous step, but we need to point to it.
          # The previous step 'Prepare package structure for SDK' created 'feed/package/openwrt-captive-monitor'.
          # We want to use that as a local feed.

          # Actually, let's just link the source directly like in
          # 'sdk-simple-build.yml'.
          # In 'sdk-simple-build.yml':
          # FEED_DIR="$GITHUB_WORKSPACE"
          # echo "src-link local $FEED_DIR" >> feeds.conf

          # Here we have 'package/openwrt-captive-monitor' in the workspace.
          # Let's use that.

          echo "src-link local ${{ github.workspace }}" >> feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install openwrt-captive-monitor

          # Config
          make defconfig

          # Compile
          echo "Compiling openwrt-captive-monitor..."
          make package/openwrt-captive-monitor/compile V=s

          # Move artifacts
          # The SDK builds to bin/packages/<arch>/local/
          # We need to move them to artifacts/${BUILD_NAME}

          mkdir -p "${{ github.workspace }}/artifacts/${BUILD_NAME}"
          find bin/packages -name "*.ipk" -exec cp {} \
            "${{ github.workspace }}/artifacts/${BUILD_NAME}/" \;

      - name: List and validate produced artifacts
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ART_DIR="artifacts/${BUILD_NAME}"
          echo "Artifacts directory: $ART_DIR"

          if [ ! -d "$ART_DIR" ]; then
            echo "ERROR: Artifact directory not found: $ART_DIR"
            exit 1
          fi

          ls -la "$ART_DIR"
          echo "IPK files:"

          # Robust IPK discovery with quoted paths and existence checks
          IPK_COUNT=0

          # Top-level .ipk files
          for ipk in "$ART_DIR"/*.ipk; do
            [ -e "$ipk" ] || continue
            basename "$ipk"
            IPK_COUNT=$((IPK_COUNT + 1))
          done

          # One-level-deep .ipk files
          for dir in "$ART_DIR"/*; do
            [ -e "$dir" ] || continue
            for f in "$dir"/*.ipk; do
              [ -e "$f" ] || continue
              basename "$f"
              IPK_COUNT=$((IPK_COUNT + 1))
            done
          done

          if [ "$IPK_COUNT" -eq 0 ]; then
            echo "error: no .ipk files found in $ART_DIR" >&2
            exit 1
          fi

      - name: Setup opkg-utils
        run: sh ./scripts/setup-opkg-utils.sh

      - name: Install verification tools
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar

      - name: Verify package internals
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Robust IPK discovery with quoted paths and existence checks
          IPK_FILE=""
          for ipk_pattern in \
            "artifacts/${BUILD_NAME}"/openwrt-captive-monitor_*.ipk; do
            if [ -e "$ipk_pattern" ]; then
              IPK_FILE="$ipk_pattern"
              break
            fi
          done

          if [ -z "$IPK_FILE" ]; then
            echo "error: no openwrt-captive-monitor package found" >&2
            exit 1
          fi
          echo "Verifying package: $IPK_FILE"
          ./scripts/verify_package.sh "$IPK_FILE"

      - name: Validate IPK version metadata
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          echo "=== Validating Version field in .ipk control metadata ==="
          for IPK_FILE in "artifacts/${BUILD_NAME}"/*.ipk; do
            if [ ! -e "$IPK_FILE" ]; then
              echo "warning: no .ipk files found" >&2
              continue
            fi
            echo ""
            echo "Validating: $(basename "$IPK_FILE")"
            # Validate Version field for main branch builds
            # (no dev/release suffix rules)
            ./scripts/validate-ipk-version.sh "$IPK_FILE" "main"
          done
          echo ""
          echo "All packages validated successfully"

      - name: Stage package artifacts with SHA256SUMS
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ./scripts/stage-package-artifacts.sh "artifacts/${BUILD_NAME}"

      - name: Upload package artifacts
        uses: actions/upload-artifact@v5
        with:
          name: captive-monitor-${{ matrix.sdk_target }}+${{ env.SHORT_SHA }}
          path: package
          retention-days: 7
          if-no-files-found: error
          compression-level: 6

      - name: Build summary
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          {
            echo "## ðŸ“¦ Build Summary"
            echo ""
            echo "**Target:** ${{ matrix.sdk_target }}"
            echo "**Architecture:** ${{ matrix.arch }}"
            echo "**OpenWrt Version:** ${{ matrix.openwrt_version }}"
            echo "**Short SHA:** ${{ env.SHORT_SHA }}"
            echo ""
            echo "### ðŸ“‹ Generated Packages"
            find "artifacts/${BUILD_NAME}" -name "*.ipk" -exec echo "- {}" \;
          } >> "$GITHUB_STEP_SUMMARY"

  build-pr-package:
    name: Build PR Package
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'
    needs: test
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        # Reuse the same SDK target coverage for PR validation builds
        include:
          - openwrt_version: '23.05.5'
            target: 'x86'
            subtarget: '64'
            arch: 'x86_64'
            sdk_slug: 'x86_64'
            sdk_target: 'x86/64'
          - openwrt_version: '23.05.5'
            target: 'ath79'
            subtarget: 'generic'
            arch: 'ath79-generic'
            sdk_slug: 'ath79-generic'
            sdk_target: 'ath79/generic'
          - openwrt_version: '23.05.5'
            target: 'ramips'
            subtarget: 'mt76x8'
            arch: 'ramips-mt76x8'
            sdk_slug: 'ramips-mt76x8'
            sdk_target: 'ramips/mt76x8'
          - openwrt_version: '23.05.5'
            target: 'mediatek'
            subtarget: 'filogic'
            arch: 'mediatek-filogic'
            sdk_slug: 'mediatek-filogic'
            sdk_target: 'mediatek/filogic'
          - openwrt_version: '23.05.5'
            target: 'ipq40xx'
            subtarget: 'generic'
            arch: 'ipq40xx-generic'
            sdk_slug: 'ipq40xx-generic'
            sdk_target: 'ipq40xx/generic'
          - openwrt_version: '23.05.5'
            target: 'ipq806x'
            subtarget: 'generic'
            arch: 'ipq806x-generic'
            sdk_slug: 'ipq806x-generic'
            sdk_target: 'ipq806x/generic'
          - openwrt_version: '23.05.5'
            target: 'bcm27xx'
            subtarget: 'bcm2711'
            arch: 'bcm27xx-bcm2711'
            sdk_slug: 'bcm27xx-bcm2711'
            sdk_target: 'bcm27xx/bcm2711'
          - openwrt_version: '23.05.5'
            target: 'rockchip'
            subtarget: 'armv8'
            arch: 'rockchip-armv8'
            sdk_slug: 'rockchip-armv8'
            sdk_target: 'rockchip/armv8'
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set build environment
        id: build-env
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Prefer an 8-character short SHA for artifact naming consistency
          resolved_sha="${GITHUB_SHA:-}"
          if [ -z "$resolved_sha" ]; then
            resolved_sha=$(git rev-parse HEAD 2> /dev/null || echo nogit)
          fi
          short_sha=$(echo "$resolved_sha" | cut -c1-8)
          {
            echo "BUILD_NAME=pr-build"
            echo "SHORT_SHA=${short_sha}"
          } >> "$GITHUB_ENV"
          echo "Using BUILD_NAME=pr-build (artifact suffix: +${short_sha})"

      - name: Prepare package structure for SDK
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Create the expected package structure for the SDK action
          mkdir -p feed/package
          cp -r package/openwrt-captive-monitor feed/package/
          # Create artifacts directory
          mkdir -p "artifacts/${BUILD_NAME}"

          # Ensure a placeholder feeds.conf.default exists for the SDK action to patch
          # The openwrt/gh-action-sdk action expects this file under FEED_DIR and will
          # inject the local src-link feed path at runtime. Upstream feeds are not required
          # for this package build.
          if [ ! -f feed/feeds.conf.default ]; then
            {
              echo "# Placeholder feeds.conf.default for SDK action"
              echo "# The action will inject: src-link ${FEEDNAME:-local} <resolved-path>"
            } > feed/feeds.conf.default
          fi

          echo "Prepared package structure:"
          find feed -type f -name "Makefile" | head -5

      - name: Validate SDK image and target
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ./scripts/validate-sdk-image.sh \
            "ghcr.io/openwrt/sdk:${{ matrix.sdk_slug }}-${{ matrix.openwrt_version }}" \
            "${{ matrix.sdk_target }}" \
            "${{ matrix.openwrt_version }}" \
            "${{ matrix.sdk_slug }}"

      - name: Build with OpenWrt SDK (${{ matrix.sdk_target }})
        uses: openwrt/gh-action-sdk@v9
        env:
          # Use the official SDK container pinned to the OpenWrt version and target
          # e.g., x86-64-23.05.5
          ARCH: ${{ matrix.sdk_slug }}-${{ matrix.openwrt_version }}
          # Package(s) to build inside the SDK
          PACKAGES: openwrt-captive-monitor
          BUILD_LOG: 1
          V: s
          # Feed configuration - use default feeds plus our local feed
          FEEDNAME: local
          # Mount points for the action
          ARTIFACTS_DIR: ${{ github.workspace }}/artifacts/${{ env.BUILD_NAME }}
          FEED_DIR: ${{ github.workspace }}/feed

      - name: List and validate produced artifacts
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ART_DIR="artifacts/${BUILD_NAME}"
          echo "Artifacts directory: $ART_DIR"

          if [ ! -d "$ART_DIR" ]; then
            echo "ERROR: Artifact directory not found: $ART_DIR"
            exit 1
          fi

          ls -la "$ART_DIR"
          echo "IPK files:"

          # Robust IPK discovery with quoted paths and existence checks
          IPK_COUNT=0

          # Top-level .ipk files
          for ipk in "$ART_DIR"/*.ipk; do
            [ -e "$ipk" ] || continue
            basename "$ipk"
            IPK_COUNT=$((IPK_COUNT + 1))
          done

          # One-level-deep .ipk files
          for dir in "$ART_DIR"/*; do
            [ -e "$dir" ] || continue
            for f in "$dir"/*.ipk; do
              [ -e "$f" ] || continue
              basename "$f"
              IPK_COUNT=$((IPK_COUNT + 1))
            done
          done

          if [ "$IPK_COUNT" -eq 0 ]; then
            echo "error: no .ipk files found in $ART_DIR" >&2
            exit 1
          fi

      - name: Install verification tools
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar

      - name: Verify package internals
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          # Robust IPK discovery with quoted paths and existence checks
          IPK_FILE=""
          for ipk_pattern in \
            "artifacts/${BUILD_NAME}"/openwrt-captive-monitor_*.ipk; do
            if [ -e "$ipk_pattern" ]; then
              IPK_FILE="$ipk_pattern"
              break
            fi
          done

          if [ -z "$IPK_FILE" ]; then
            echo "error: no openwrt-captive-monitor package found" >&2
            exit 1
          fi
          echo "Verifying package: $IPK_FILE"
          ./scripts/verify_package.sh "$IPK_FILE"

      - name: Validate IPK version metadata
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          echo "=== Validating Version field in .ipk control metadata ==="
          for IPK_FILE in "artifacts/${BUILD_NAME}"/*.ipk; do
            if [ ! -e "$IPK_FILE" ]; then
              echo "warning: no .ipk files found" >&2
              continue
            fi
            echo ""
            echo "Validating: $(basename "$IPK_FILE")"
            # Validate Version field for PR builds (no dev/release suffix rules)
            ./scripts/validate-ipk-version.sh "$IPK_FILE" "pr"
          done
          echo ""
          echo "All packages validated successfully"

      - name: Stage package artifacts with SHA256SUMS
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          ./scripts/stage-package-artifacts.sh "artifacts/${BUILD_NAME}"

      - name: Upload PR artifacts
        uses: actions/upload-artifact@v5
        with:
          name: captive-monitor-${{ matrix.sdk_target }}-pr+${{ env.SHORT_SHA }}
          path: package
          retention-days: 7
          if-no-files-found: error
          compression-level: 6

      - name: Build summary
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          {
            echo "## ðŸ“¦ Build Summary"
            echo ""
            echo "**Target:** ${{ matrix.sdk_target }}"
            echo "**Architecture:** ${{ matrix.arch }}"
            echo "**OpenWrt Version:** ${{ matrix.openwrt_version }}"
            echo "**Short SHA:** ${{ env.SHORT_SHA }}"
            echo ""
            echo "### ðŸ“‹ Generated Packages"
            find "artifacts/${BUILD_NAME}" -name "*.ipk" -exec echo "- {}" \;
          } >> "$GITHUB_STEP_SUMMARY"

name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  lint:
    name: Lint (${{ matrix.linter }})
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    strategy:
      matrix:
        linter:
          - shfmt
          - shellcheck
          - markdownlint
          - actionlint

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Install base dependencies
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar

      - name: Install linter dependencies
        if: matrix.linter == 'shfmt' || matrix.linter == 'shellcheck'
        uses: ./.github/actions/setup-system-packages
        with:
          packages: busybox shfmt shellcheck

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          check-latest: true

      - name: Show Node.js version
        run: node --version

      - name: Run shfmt
        if: matrix.linter == 'shfmt'
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          shfmt -d -s -i 4 -ci -sr .

      - name: Run shellcheck
        if: matrix.linter == 'shellcheck'
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          find . -type f -name "*.sh" -exec shellcheck {} +
          shellcheck openwrt_captive_monitor.sh

      - name: Run markdownlint
        if: matrix.linter == 'markdownlint'
        uses: DavidAnson/markdownlint-cli2-action@v20
        with:
          config: '.markdownlint.json'
          files: '**/*.md'

      - name: Run actionlint
        if: matrix.linter == 'actionlint'
        uses: reviewdog/action-actionlint@v1
        with:
          fail_level: error

  test:
    name: Test
    runs-on: ubuntu-24.04
    needs: lint
    permissions:
      contents: read
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Install test dependencies
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar busybox

      - name: Run test harness with BusyBox ash
        run: |
          set -eu
          if (set -o pipefail) 2> /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi
          busybox ash tests/run.sh

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results
          path: tests/_out/
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  build-dev-package:
    name: Build Dev Package
    runs-on: ubuntu-24.04
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - openwrt_version: '23.05.3'
            target: 'x86'
            subtarget: '64'
            arch: 'x86_64'
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set dev channel environment
        id: dev-env
        run: |
          set -euo pipefail
          short_sha=$(echo "${GITHUB_SHA:-$(git rev-parse --short HEAD 2>/dev/null || echo nogit)}" | cut -c1-7)
          {
            echo "BUILD_CHANNEL=dev"
            echo "BUILD_NAME=dev-main"
            echo "SHORT_SHA=${short_sha}"
          } >> "$GITHUB_ENV"
          echo "Using BUILD_NAME=dev-main (artifact suffix: -dev+${short_sha})"

      - name: Prepare package structure for SDK
        run: |
          set -euo pipefail
          mkdir -p feed/package
          cp -r package/openwrt-captive-monitor feed/package/
          mkdir -p "artifacts/${BUILD_NAME}"
          echo "Prepared package structure:"
          find feed -type f -name "Makefile" | head -5

      - name: Build with OpenWrt SDK (${{ matrix.target }}/${{ matrix.subtarget }})
        uses: openwrt/gh-action-sdk@v6
        with:
          version: ${{ matrix.openwrt_version }}
          target: ${{ matrix.target }}
          subtarget: ${{ matrix.subtarget }}
          feeds: |
            src-link local ${{ github.workspace }}/feed
          packages: |
            openwrt-captive-monitor

      - name: Stage build artifacts
        run: |
          set -euo pipefail
          sh ./scripts/stage_artifacts.sh

      - name: Install inspection dependencies
        uses: ./.github/actions/setup-system-packages
        with:
          packages: binutils tar

      - name: List and validate produced artifacts
        run: |
          set -euo pipefail
          ART_DIR="artifacts/${BUILD_NAME}"
          echo "Artifacts directory: $ART_DIR"
          ls -la "$ART_DIR"
          echo "IPK files:"
          find "$ART_DIR" -name "*.ipk" -printf '%f\n' || true
          COUNT=$(find "$ART_DIR" -name "*.ipk" | wc -l | tr -d ' ')
          if [ "$COUNT" -eq 0 ]; then
            echo "error: no .ipk files found in $ART_DIR" >&2
            exit 1
          fi

      - name: Verify package internals
        run: |
          set -euo pipefail
          IPK_FILE=$(find "artifacts/${BUILD_NAME}" -name "openwrt-captive-monitor_*.ipk" | head -n1)
          if [ -z "$IPK_FILE" ]; then
            echo "error: no openwrt-captive-monitor package found" >&2
            exit 1
          fi
          echo "Verifying package: $IPK_FILE"
          ./scripts/verify_package.sh "$IPK_FILE"

      - name: Upload dev artifacts
        uses: actions/upload-artifact@v5
        with:
          name: openwrt-dev-package-dev+${{ env.SHORT_SHA }}-${{ matrix.target }}-${{ matrix.subtarget }}-${{ matrix.arch }}
          path: artifacts/${{ env.BUILD_NAME }}
          retention-days: 7
          if-no-files-found: error
          compression-level: 6

      - name: Build summary
        run: |
          set -euo pipefail
          echo "## ðŸ“¦ Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Target:** ${{ matrix.target }}/${{ matrix.subtarget }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Architecture:** ${{ matrix.arch }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**OpenWrt Version:** ${{ matrix.openwrt_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Build Channel:** ${{ env.BUILD_CHANNEL }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Short SHA:** ${{ env.SHORT_SHA }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ“‹ Generated Packages" >> "$GITHUB_STEP_SUMMARY"
          find "artifacts/${BUILD_NAME}" -name "*.ipk" -exec echo "- {}" \; >> "$GITHUB_STEP_SUMMARY"

name: Security Scanning

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  schedule:
    # Run weekly on Tuesday at 00:00 UTC
    - cron: '0 0 * * 2'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    # Run only on pull requests
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always
          deny-licenses: GPL-3.0, AGPL-3.0
          retry-on-snapshot-warnings: true

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    permissions:
      security-events: write
      contents: read
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
          ignore-unfixed: true
          scanners: 'vuln,misconfig'
          skip-dirs: 'security_audit,venv,tests,node_modules'

      - name: Verify Trivy SARIF file exists
        if: always()
        run: |
          if [ -f trivy-results.sarif ]; then
            echo "✓ Trivy SARIF file found"
            ls -lh trivy-results.sarif
          else
            echo "✗ Trivy SARIF file not found"
            echo "Current directory contents:"
            ls -la
          fi

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy-scan

  shellcheck-security:
    name: ShellCheck Security Analysis
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    permissions:
      security-events: write
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Install ShellCheck and jq
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install -y shellcheck jq

      - name: Run ShellCheck and convert to SARIF
        run: |
          set -euo pipefail
          mkdir -p shellcheck-results

          # Find all shell scripts
          SHELL_SCRIPTS=$(find . -type f -name "*.sh" -not -path "./.git/*" -not -path "./tests/*" | tr '\n' ' ')

          # Also check the main script
          if [ -f openwrt_captive_monitor.sh ]; then
            SHELL_SCRIPTS="$SHELL_SCRIPTS openwrt_captive_monitor.sh"
          fi

          # Run shellcheck and convert to SARIF
          if [ -n "$SHELL_SCRIPTS" ]; then
            # shellcheck disable=SC2086
            shellcheck --format=json $SHELL_SCRIPTS > shellcheck-output.json || true

            # Convert to SARIF format using a jq script
            # Note: $schema below is a jq/JSON field, not a shell variable
            # shellcheck disable=SC2016
            cat > convert-to-sarif.jq << 'JQSCRIPT'
          [.[] | select(.level == "error" or .level == "warning")] as $issues |
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "ShellCheck",
                  "informationUri": "https://www.shellcheck.net/",
                  "version": "0.9.0",
                  "rules": []
                }
              },
              "results": $issues | map({
                "ruleId": ("SC" + (.code | tostring)),
                "level": (if .level == "error" then "error" else "warning" end),
                "message": {
                  "text": .message
                },
                "locations": [{
                  "physicalLocation": {
                    "artifactLocation": {
                      "uri": .file
                    },
                    "region": {
                      "startLine": .line,
                      "startColumn": .column
                    }
                  }
                }]
              })
            }]
          }
          JQSCRIPT

            jq -f convert-to-sarif.jq shellcheck-output.json > shellcheck-results/shellcheck.sarif
          else
            echo "No shell scripts found to analyze"
            echo '{"$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json", "version": "2.1.0", "runs": []}' > shellcheck-results/shellcheck.sarif
          fi

      - name: Verify ShellCheck SARIF file exists
        if: always()
        run: |
          if [ -f shellcheck-results/shellcheck.sarif ]; then
            echo "✓ ShellCheck SARIF file found"
            ls -lh shellcheck-results/shellcheck.sarif
          else
            echo "✗ ShellCheck SARIF file not found"
            echo "Current directory contents:"
            ls -la
            echo "shellcheck-results directory contents (if exists):"
            if [ -d shellcheck-results ]; then
              ls -la shellcheck-results/
            fi
          fi

      - name: Upload ShellCheck SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: shellcheck-results/shellcheck.sarif
          category: shellcheck-security

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-24.04
    needs: [dependency-review, trivy-scan, shellcheck-security]
    if: always()

    permissions:
      contents: read

    steps:
      - name: Generate security scan summary
        run: |
          {
            echo "## Security Scan Results"
            echo ""
            echo "| Scanner | Status |"
            echo "|---------|--------|"
            echo "| Trivy | ${{ needs.trivy-scan.result }} |"
            echo "| ShellCheck | ${{ needs.shellcheck-security.result }} |"
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "| Dependency Review | ${{ needs.dependency-review.result }} |"
            else
              echo "| Dependency Review | Skipped (PR only) |"
            fi
            echo ""
            echo "Security findings have been uploaded to the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)."
          } >> "$GITHUB_STEP_SUMMARY"

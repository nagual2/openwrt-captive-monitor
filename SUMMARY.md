# OpenWrt Captive Monitor — аудит под OpenWrt 24.x (filogic/AX3000T)

## Объём и подход
- Цель аудита — оценить готовность проекта к запуску на OpenWrt 24.x с новым сетевым стеком (`fw4`/nftables) на платформе MediaTek Filogic (ориентир — Xiaomi Mi Router AX3000T, ARMv8) и собрать план работ.
- Анализ проводился без доступа к аппаратуре: выводы основаны на чтении исходников (`openwrt_captive_monitor.sh`, `package/.../usr/sbin/openwrt_captive_monitor`, init-скрипты, `docs/`), статическом анализе (`shellcheck`, `shfmt`) и знании стандартных компонентов OpenWrt (BusyBox ash 1.36, netifd/procd, dnsmasq, fw4, mt76).
- Все детальные материалы: `docs/STATIC_ANALYSIS.md` (результаты lint-проверок), `docs/BACKLOG.md` (приоритезированный план на три итерации), `docs/TEST_PLAN.md` (план тестов для 24.x/filogic).

## Структура репозитория
- `openwrt_captive_monitor.sh` и `init.d/captive-monitor` — тонкие launchers, прокидывающие вызовы в локальную сборку из `package/` либо в системные бинари.
- `package/openwrt-captive-monitor/` — основной OpenWrt-пакет: Makefile, рабочий скрипт (`files/usr/sbin/openwrt_captive_monitor` на ~1.4k строк), init-скрипт, uci-defaults и служебные файлы.
- `scripts/build_ipk.sh` — утилита сборки IPK и генерации opkg feed.
- `docs/` — документация (backlog, тест-план, release checklist и README по развёртыванию).

## Статический анализ (ShellCheck + shfmt)
- Команды: `shellcheck -s sh <все скрипты>` и `shfmt -i 2 -ci -sr -d <скрипты>`. Пакеты `shellcheck` и `shfmt` установлены в окружение через apt.
- Первичный прогон выявил предупреждения уровня minor (ложноположительные SC2034/SC2154/SC1091) и стилистические замечания SC2129/SC3043. В рамках быстрых правок:
  - Добавлены поясняющие директивы ShellCheck в init-скрипте (`START/STOP/USE_PROCD` используются rc.common, `. /lib/functions.sh` доступен в рантайме procd).
  - Инициализированы значения `enabled/mode/...` до вызовов `config_get*`, чтобы исключить SC2154.
  - Убрано использование `local` из init-скрипта и сгруппированы записи в `scripts/build_ipk.sh`, что устранило SC3043/SC2129.
  - Для `build_ipk.sh` оставлено целевое подавление SC3043: скрипт выполняется под ash/ bash и требует `local` для читабельности функций.
- shfmt формирует дифф ~2.6k строк (преимущественно переиндентация с 4 на 2 пробела и выравнивание heredoc). Автоматическое форматирование рекомендуется выносить в отдельный PR после появления автоматических тестов (см. `docs/STATIC_ANALYSIS.md`).

## Совместимость с OpenWrt 24.x / Filogic
- **Shell / BusyBox**: код опирается на ash-совместимые конструкции (`local`, `$(...)`, `trap`). BusyBox 1.36 их поддерживает. Ветвь `resolveip -s` в `resolve_portal_ipv4` не будет работать на BusyBox (нет флага `-s`) — требуется замена на `nslookup`/`host`.
- **netifd / DSA**: helpers `ensure_lan_interface`/`ensure_lan_ip` ожидают `br-lan`, что совпадает с DSA на Filogic. Значения по умолчанию для Wi-Fi (`phy1-sta0`/`wwan`) не совпадают с именами интерфейсов AX3000T — нужен автоопределитель через `ubus network.wireless` или документация по настройке.
- **procd**: init-скрипт использует `USE_PROCD=1` и `procd_set_param respawn`, но не реализует `depends()` и не вызывает `procd_kill` при остановке. Переменные окружения из UCI пробрасываются частично (нет `LAN_IPV6`, `CAPTIVE_CHECK_URLS`, `REQUESTED_FIREWALL_BACKEND`).
- **dnsmasq**: перехват реализован через drop-in в `/tmp/dnsmasq.d` с перезапуском сервиса. Нужно подтвердить, что перезагрузка не конфликтует с `odhcpd`/`dnsmasq-full` в сборке 24.x.
- **fw4 / nftables**: режим `nftables` создаёт таблицу `inet captive_monitor` с `prerouting`-цепью (`priority dstnat`). Таблица очищается при выходе, но не обрабатывается сценарий `fw4 reload`, когда пользовательский ruleset может быть пересобран поверх цепей. IPv6 DNAT включается только при `HTTPD_IPV6_READY=1`.
- **iptables(-nft)**: fallback использует собственные цепочки `CAPTIVE_*`. На 24.x iptables — тонкая обёртка над nft, поэтому требуется тест на совместимость проверок `iptables -C` и очистки.

## Диагностика и восстановление соединения
- `check_gateway`/`check_internet` используют ICMP (`ping`) и фиксированные списки адресов. При блокировке ICMP скрипт будет повторно перезапускать Wi‑Fi без экспоненциальной задержки.
- Обнаружение captive-портала основано на `curl` с тайм-аутом 7 с и списке URL (`connectivitycheck`, `firefox`). Парсинг ищет `Location`, meta refresh и первую ссылку — HTTPS-порталы без явного редиректа остаются незамеченными.
- `restart_wifi` пробует `ifdown/ifup` логического интерфейса, затем `ip link set` физического. Арбитраж по `MAX_WAIT_TIME` (90 с) подходит для mt76, но нужен учёт `wifi reload` и пауз между попытками.
- Очистка (`trap cleanup EXIT`) выключает httpd, удаляет DNS-конфиг и цепочки. При жёстком `kill -9` или краше процесса возможны «залипшие» правила nft — требуется ручная проверка в тест-плане.

## Интеграция с procd
- `start_service` логирует запуск и в monitor-режиме включает `respawn 3600 5 5`, но отсутствует `depends()` для dnsmasq/network и нет явного вызова `procd_kill` в `stop_service`.
- `reload_service` вызывает `stop`+`start`, что безопасно, но при отсутствии `procd_kill` процесс может остаться активным.
- Oneshoot (ручной запуск) требует валидации входных параметров и более строгой проверки наличия бинарей (`curl`, `busybox httpd`, `nft`, `iptables`).

## Сетевой перехват (fw4 / nftables / iptables)
- При активном портале создаётся HTTP-заглушка (`busybox httpd`) на `HTTPD_PORT` (8080) и DNS-override, которые перенаправляют трафик на LAN IP точки доступа.
- Режим `nftables` добавляет DNAT для 80/TCP и DNS (53/TCP/UDP) c возможностью проброса IPv6. Белые списки реализованы через `return` по IP портала.
- Режим `iptables` модифицирует `PREROUTING`/`nat` и `filter` (цепочки `CAPTIVE_HTTP_REDIRECT`, `CAPTIVE_DNS_REDIRECT`). Важно проверить отсутствие конфликтов с `fw4` (который генерирует nft набор правил) и корректность очистки при перезапусках firewall.
- HTTPS-трафик не перехватывается — пользователям нужно вручную открыть HTTP-сайт.

## UCI-конфигурация
- `/etc/config/captive-monitor` предоставляет базовые параметры (enable, mode, Wi‑Fi интерфейсы, интервалы, список URL). Не хватает опций для таймаутов health-check, выбора firewall backend, HTTP-порта и политики IPv6.
- Значения по умолчанию требуют адаптации под Filogic (интерфейсы, порты, списки серверов). Нужна авто-валидация конфигурации и явные сообщения об ошибках.

## Логирование и наблюдаемость
- Логирование идёт через обёртки `log_info/log_warn/log_error` с префиксом `captive-monitor` (уровни `user.info/user.warn/user.err`).
- В monitor-режиме вывод дублируется в stdout, что засоряет `logread`. Стоит добавить режим `--syslog-only` или порог уровней.
- Нет интеграции с `ubus`: невозможно запросить состояние службы из LuCI, отсутствуют события о смене состояния.

## Ключевые риски
1. ✅ *Закрыто:* скрипт больше не использует `resolveip -s`; определение IP портала выполняется через совместимый `nslookup` с резервными сценариями.
2. ✅ *Закрыто:* health-check дополнился HTTP/HTTPS probe'ами, экспоненциальным бэкоффом и раздельными таймаутами; блокировка ICMP больше не приводит к бесконечным перезапускам Wi‑Fi.
3. Сценарии `fw4 reload` и ручные изменения правил могут привести к потерянным/дублированным цепочкам nft.
4. Нет перехвата HTTPS и уведомлений пользователю — UX на публичных порталах остаётся слабым.
5. init-скрипт всё ещё не объявляет procd-зависимости на `network`/`dnsmasq`; убийство процесса при `stop` теперь выполняется, но зависимость стоит задокументировать и внедрить отдельно.
6. Автоконфигурация Wi‑Fi и LAN ограничена: значения по умолчанию не совпадают с именами интерфейсов на Filogic.
7. Отсутствуют автоматические тесты — изменения в firewall/DNS логике сложно проверять без железа.

## Быстрые победы, реализованные сейчас
- Добавлены адресные инструкции ShellCheck в init-скрипте, устранены ложноположительные предупреждения и инициализированы UCI-переменные по умолчанию.
- Убрано использование `local` из init-скрипта, что делает его совместимым с чистым POSIX.
- Приведено формирование `Packages` в `scripts/build_ipk.sh` к атомарному виду (групповой редирект) и задокументировано использование `local`.
- Подтверждено наличие репозитория `.editorconfig`, `.shfmt.conf`, `.shellcheckrc`, шаблона `package/Makefile.template` и workflow `.github/workflows/shellcheck.yml`, который запускает `shfmt`, `shellcheck` и синтаксическую проверку init-скриптов.

## Следующие шаги
- Детальный план задач по трём итерациям (стабилизация → UX/наблюдаемость → пакет/CI) — в `docs/BACKLOG.md`.
- Тест-план для OpenWrt 24.x / Filogic, включая captive-сценарии, перезапуск Wi‑Fi, очистку правил и проверку `fw4 reload`, — в `docs/TEST_PLAN.md`.
- После реализации критических изменений обязательны полевые испытания на реальном AX3000T.

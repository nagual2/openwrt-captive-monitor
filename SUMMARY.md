# OpenWrt Captive Monitor — аудит текущего состояния

## Структура репозитория
- `openwrt_captive_monitor.sh` — тонкий launcher, который предпочитает локально скомпилированный бинарь/скрипт из `package/` и системную установку, иначе сообщает об ошибке.
- `init.d/captive-monitor` — аналогичный launcher для init-скрипта; основной `procd`-совместимый скрипт лежит в пакете.
- `package/openwrt-captive-monitor/` — OpenWrt пакет: Makefile, основная логика (`files/usr/sbin/openwrt_captive_monitor`), init-скрипт, UCI defaults и конфиг.
- `scripts/build_ipk.sh` — вспомогательный скрипт сборки IPK/фида.
- `docs/` — подробная документация по функционалу и выпуску.

Quick wins, выполненные в рамках аудита:
- Добавлен `.editorconfig` с настройками для двухпробельного шелового формата (shfmt-friendly).
- В основном скрипте проставлено точечное подавление `SC3043` (использование `local` в ash-профиле).
- Обновлён GitHub Actions workflow (`Lint`) — теперь он запускает `shfmt` и `shellcheck -s sh`, а также проверяет синтаксис установленного init-скрипта без прав суперпользователя.

## Статический анализ

### ShellCheck (`shellcheck -s sh`)
| Файл | Предупреждение | Кол-во | Классификация | Предложение |
| --- | --- | --- | --- | --- |
| `package/.../openwrt_captive_monitor` | SC3043: `local` не описан POSIX sh | 64 | Major | Сценарий целится в BusyBox ash; оставить `local`, но явно зафиксировать профиль. Выполнено: `# shellcheck disable=SC3043` рядом с директивой `shellcheck shell=ash`. Альтернатива — запускать `shellcheck` в профиле ash (`-s ash`). |
| `scripts/build_ipk.sh` | SC3043: `local` в POSIX sh | 2 | Major | Аналогично: скрипт рассчитан на ash/bash. Можно переключить shellcheck на `ash` или переписать на POSIX-подход (временные positional параметры вместо `local`). |
| `scripts/build_ipk.sh` | SC2129: объединить несколько `cat >>` | 1 | Minor | Обернуть последовательность в `{ ...; } >> file` или использовать `tee -a`. |
| `openwrt_captive_monitor.sh`, `init.d/captive-monitor`, `package/.../etc/init.d/captive-monitor` | Нет | — | — | — |

> После добавления подавления `SC3043` основная логика проходит `shellcheck -s sh` без предупреждений.

### `shfmt -i 2 -ci -sr`
- Форматирование отличается от целевого двухпробельного стандарта почти во всех скриптах (`openwrt_captive_monitor.sh`, `init.d/captive-monitor`, основной скрипт в пакете, `scripts/build_ipk.sh`).
- Диффы достигают полного переиндентирования файлов; перед автоматическим выравниванием стоит согласовать стиль (исторически использовались 4 пробела) и разбить правку на отдельный PR.
- Для управления форматом добавлен `.editorconfig`; можно использовать `shfmt -w $(git ls-files '*.sh')` после принятия решения о смене стиля.

## Совместимость и зависимости
- **Shell/BusyBox**: все shebang'и указывают на `/bin/sh`; активно используется `local`, массивы командной подстановки и утилиты BusyBox (`ip`, `nslookup`, `busybox httpd`, `logger`). Скрипт рассчитан на BusyBox ash, а не на строгий POSIX `sh`.
- **OpenWrt 22.03 / 23.05 / 24.xx**:
  - Нацелено на netifd (`ifup/ifdown`), `dnsmasq`, `procd`. В 22.03+ по умолчанию используется `fw4` (nftables); реализована своя таблица `captive_monitor` с `hook prerouting`, не затрагивающая основной `fw4` config, но нужно следить, чтобы fw4 не очищал внешние таблицы при `fw4 reload`.
  - В профилях, где остаётся `iptables-legacy`, код создает собственные цепочки в `nat` и вешает их в `PREROUTING`. Не обрабатывается режим `iptables-nft` (симлинк в nft), что может потребовать дополнительной проверки в 23.05+.
- **Пакетные зависимости**: `DEPENDS:=+dnsmasq +curl`. `curl` не входит в минимальную прошивку, но пакет подтянет зависимость. Для «ручного» запуска без пакета нужны инструкции по установке.
- **logger/ubus**: используется `logger -t captive-monitor`; прямой интеграции с `ubus`/`procd` events нет.
- **UCI**: конфиг `captive-monitor.config` с параметрами Wi-Fi, интервалов, списков URL. Значения по умолчанию (`phy1-sta0`, `wwan`) могут не совпадать с типичными именами интерфейсов (чаще `wlan0`/`wlan1`).

## Надёжность и устойчивость логики
- **Проверка соединения**: `check_internet` циклически пингует список адресов (по умолчанию 3 попытки × 3 сервера). При строгих фаерволах ICMP может быть заблокирован ⇒ нужна HTTP/HTTPS проверка.
- **Диагностика captive-портала**: полагается на `curl` c тайм-аутом 7s; анализирует `Location`, meta refresh и первый `href`. Нет fallback на `wget`, нет проверки HTTPS-only порталов.
- **Перезапуск Wi-Fi**: сначала пробует логический интерфейс (`ifdown/ifup`), затем физический через `ip link set down/up`, ожидая IP до 90с. Нет проверки успешной реассоциации/SSID; при DSA и mesh могут потребоваться дополнительные шаги.
- **DNS/HTTP/HTTPS**:
  - Перехват DNS: создаётся `/tmp/dnsmasq.d/captive_intercept.conf` c `address=/#/`. При отключении файл удаляется и `dnsmasq` перезагружается. Риск: сторонние кастомные настройки `dnsmasq` в `/tmp/dnsmasq.d` могут конфликтовать.
  - HTTP редирект: `busybox httpd` слушает 8080 (IPv4+IPv6 при наличии). HTTPS не перехватывается — клиенты увидят предупреждение о сертификате. Планируется DNAT на 80/443, но HTTPS отсутствует.
  - IPv6: DNAT добавляется только при `HTTPD_IPV6_READY=1` и наличии `LAN_IPV6`, но httpd слушает HTTPS? нет. IPv6 DNS/HTTP правила формируются, но без локального сертификата бесполезны.
- **Очистка**: `trap` на `EXIT` вызывает `cleanup_captive_intercept`, который удаляет правила и останавливает httpd. При аварийном завершении `busybox httpd` PID-файл удаляется. Не очищаются потенциальные остатки в `nft` при ручном убийстве процесса до завершения `trap` (редкий кейс).

## Init-скрипт (`package/.../etc/init.d/captive-monitor`)
- Использует `USE_PROCD=1`, `procd_open_instance`, `respawn` (только в режиме monitor).
- `depends()` не определён — сервис не объявляет зависимости от `network`/`dnsmasq`; reliance на service triggers `procd_add_reload_trigger` (network, captive-monitor).
- `stop_service()` лишь пишет в лог; повторный запуск полагается на procd, но нет явного `procd_kill`. Стоит рассмотреть `procd_kill` или `procd_close_instance` с `procd_set_param respawn 0` при oneshot.
- `reload_service()` реализован как `stop; start`, что для monitor-режима допустимо, но oneshot запустится повторно.
- Не пробрасываются переменные окружения для всех UCI параметров (например, `LAN_IPV6`, `CAPTIVE_CHECK_URLS`, `REQUESTED_FIREWALL_BACKEND`).

## Логи и наблюдаемость
- Собственные функции `log_info/log_warn/log_error`, печать в stdout/stderr и duplicating в `logger` при `ENABLE_SYSLOG=1`.
- При oneshot-режиме логи утекают в stdout; стоит добавить опцию подавления `logger` либо единое форматирование (`logger -p user.notice`).
- Ротация/ограничение verbosity отсутствуют; monitor-режим каждую минуту выводит блок `=== Проверка подключения ===`.

## Основные риски и потенциальные несовместимости
1. **Жёсткая зависимость от ICMP и curl** — на сетях с блокировкой ICMP/HTTP скрипт будет всегда считать интернет недоступным и уходить в перезапуски.
2. **Цепочки nftables/iptables** — ручное управление таблицами может конфликтовать с fw4 reload или пользовательскими правилами; требуется аккуратная интеграция через UCI/uci-forward firewall sections.
3. **HTTPS не обслуживается** — клиенты получат ошибку сертификации; нужен как минимум информативный landing page с инструкциями.
4. **Интервалы и тайм-ауты** — фиксированные значения без экспоненциальной задержки, возможна нагрузка на сеть/портал.
5. **Совместимость с DSA/WPA3/mesh** — интерфейсы (`phy1-sta0`) по умолчанию некорректны; нужно автоопределение и документация.
6. **`resolveip -s`** — опция `-s` отсутствует в BusyBox `resolveip`; ветка никогда не отработает на штатных сборках, нужно заменить на `nslookup`/`host`.
7. **Нет юнит/интеграционных тестов** — любое изменение может сломать DNAT или перезапуск Wi-Fi.

## Дальнейшие шаги
Детализированный план доработок по итерациям и тест-план размещены соответственно в `docs/BACKLOG.md` и `docs/TEST_PLAN.md`.

# OpenWrt Captive Monitor — аудит под OpenWrt 24.x (filogic/AX3000T)

## Объём и контекст
- Цель аудита — подготовить дорожную карту для запуска на OpenWrt 24.x с новым сетевым стеком (`fw4`/nftables) на платформе MediaTek Filogic (пример устройства — Xiaomi Mi Router AX3000T, ARMv8).
- Живого железа нет: выводы основаны на статическом анализе, логике скриптов и совместимости с мейнлайновыми компонентами (BusyBox ash 1.36, netifd/procd, dnsmasq, mt76).
- Все артефакты аудита: `docs/STATIC_ANALYSIS.md`, обновлённые `docs/BACKLOG.md` и `docs/TEST_PLAN.md`.

## Структура репозитория
- `openwrt_captive_monitor.sh` — тонкий launcher, пытается запустить локальную сборку из `package/` и затем системный `/usr/sbin/openwrt_captive_monitor`.
- `init.d/captive-monitor` — аналогичный launcher для init-скрипта.
- `package/openwrt-captive-monitor/` — основной пакет: Makefile, скрипт `files/usr/sbin/openwrt_captive_monitor`, init-скрипт и UCI defaults.
- `package/Makefile.template` — новый шаблон Makefile для дальнейших пакетов.
- `scripts/build_ipk.sh` — сборка IPK и opkg feed.
- `docs/` — документация, включая новое резюме по статическому анализу.

## Статический анализ
- **ShellCheck (`shellcheck -s sh`)**: предупреждений нет для всех скриптов (`openwrt_captive_monitor.sh`, оба init-скрипта, основной бинарник, `scripts/build_ipk.sh`). В `openwrt_captive_monitor` уже присутствует адресное подавление `SC3043`, фиксирующее профиль ash.
- **shfmt (`-i 2 -ci -sr`)**: обнаружено глобальное расхождение стиля (основной код выровнен на 4 пробела). Дифф особенно крупный в `files/usr/sbin/openwrt_captive_monitor` (>1k строк). Детали и классификация приведены в `docs/STATIC_ANALYSIS.md`.

## Совместимость с OpenWrt 24.x (filogic)
- **Shell / BusyBox**: скрипты используют `/bin/sh` + ash-расширения (`local`, `[[` отсутствует). BusyBox 1.36 на OpenWrt 24.x поддерживает применяемые утилиты (`ip`, `nslookup`, `logger`, `busybox httpd`). `resolveip -s` остаётся проблемой: ключ `-s` отсутствует в BusyBox, поэтому ветка не выполнится на реальном устройстве.
- **netifd / DSA**: `ensure_lan_interface` по умолчанию возвращает `br-lan`, что соответствует DSA на MT798x. Wi-Fi интерфейсы по умолчанию (`phy1-sta0`/`wwan`) не совпадают с именованием на AX3000T — потребуется автодетект через `ubus network.wireless`.
- **procd**: init-скрипт использует `USE_PROCD=1`, но не определяет `depends()` и пробрасывает не все переменные окружения (нет `LAN_IPV6`, `CAPTIVE_CHECK_URLS`, `REQUESTED_FIREWALL_BACKEND`). `stop_service` логирует, но не вызывает `procd_kill`, из-за чего при ручном `stop` процесс остаётся запущенным.
- **dnsmasq**: перехват реализован через `dnsmasq.d` и перезагрузку сервиса. Для 24.x важно убедиться, что перезагрузка не выбивает опции от `odhcpd`/`dnsmasq-full`; требуется smoke-test в rootfs.
- **fw4 / nftables**: присутствует режим `nftables` с отдельной таблицей `inet captive_monitor` (`hook prerouting priority dstnat`). Пока не уделено внимание сценариям `fw4 reload` и пользовательским правилам; таблица удаляется полностью, что помогает избежать утечек, но стоит документировать порядок вызова.
- **iptables(-nft)**: fallback активен, создаёт собственные цепочки `CAPTIVE_*`. На OpenWrt 24.x iptables — обёртка над nft, поэтому нужно тестирование, чтобы убедиться в корректной работе DNAT через iptables-nft.

## Логика health-check и восстановление Wi‑Fi
- `check_gateway` и `check_internet` опираются на ICMP (`ping`). При блокировке ICMP скрипт начнёт постоянные перезапуски Wi-Fi.
- `detect_captive_portal` использует `curl` (тайм-аут 7 c) и анализ ответов (`Location`, meta refresh, первый `href`). HTTPS-порталы без явного редиректа могут пройти мимо. Нет экспоненциальной задержки между проверками.
- `restart_wifi` работает сначала с логическим интерфейсом (`ifdown/ifup`), затем с физическим (`ip link set`). Для mt76/Filogic важно учесть необходимость `wifi reload` и время стабилизации (макс. ожидание 90 c).
- Очистка (`trap EXIT`) корректно гасит httpd, удаляет DNS и firewall-правила, однако при аварийном `kill -9` таблица nft может остаться.

## Сетевой перехват и firewall
- В режиме nftables создаётся полная таблица: DNAT для HTTP (80/tcp) и DNS (53/tcp/udp), с IPv6-ветками при `HTTPD_IPV6_READY=1`. При наличии истинного портала возможен «белый список» через `return` по адресу портала.
- HTTPS-трафик не перехватывается (нет DNAT на 443, нет сертификата). Клиенты увидят TLS предупреждение либо вовсе не перенаправятся.
- В режиме iptables/ip6tables правила добавляются и очищаются в цикле; на системах с `iptables-nft` нужно убедиться, что комментарии и проверки наличия правил (`-C`) работают предсказуемо.

## UCI конфигурация
- `/etc/config/captive-monitor` содержит базовые параметры (enable, mode, Wi-Fi интерфейсы, интервалы, список URL). Нет опций для таймаутов health-check, выбора firewall backend по умолчанию, HTTP-порта, IPv6-поведения.
- Значения по умолчанию (`phy1-sta0`, `wwan`) не подходят для большинства сборок; необходимо автоопределение или интерактивная документация.

## Логи и наблюдаемость
- Собственная обёртка над `logger` с префиксом `captive-monitor`. Уровни соответствуют `user.info/user.warn/user.err`.
- В monitor-режиме выводится много повторяющихся баннеров; стоит упорядочить вывод и ввести ключ `--quiet/--syslog-only`.
- Отсутствует интеграция с `ubus` (невозможно запросить состояние сервиса из LuCI). Для OpenWrt 24.x рекомендуются `ubus` события либо статус-файл в `/var/run`.

## Ключевые риски для запуска на AX3000T
1. **Неподдерживаемый `resolveip -s`**: ветка с указанием DNS никогда не выполнится, что затруднит обход пользовательских DNS.
2. **ICMP-зависимая диагностика**: сети, блокирующие ping, заставят скрипт бесконечно перезапускать Wi-Fi и держать captive-перехват активным.
3. **fw4 reload / пользовательские правила**: собственная таблица nft может конкурировать по приоритету, требуется тест на `fw4 reload` и документация.
4. **Отсутствие HTTPS перехвата**: пользователям придётся вручную открывать http-сайт; UX на публичных порталах страдает.
5. **Недостаток автоконфигурации интерфейсов**: дефолты не подходят для Filogic/AX3000T, нужно автоопределение и проверка ошибок конфигурации.
6. **procd stop/reload**: отсутствие `depends()` и `procd_kill` приводит к висящим процессам и гонкам при рестарте.
7. **Нет автоматических тестов**: любые правки в `setup_firewall_redirects_*` или dnsmasq-конфигурации остаются без регрессии.

## Быстрые победы, выполненные в рамках аудита
- Добавлен `.shfmt.conf` с целевыми параметрами форматирования (`-i 2 -ci -sr`).
- Создан `package/Makefile.template` для быстрых экспериментов с пакетами на базе данного проекта.
- Подготовлен подробный отчёт `docs/STATIC_ANALYSIS.md` с классификацией shfmt-диффов и фиксацией отсутствия предупреждений ShellCheck.

## Следующие шаги
- Приоритеты и оценки по трём итерациям (стабилизация → UX/логирование → пакет/CI) приведены в `docs/BACKLOG.md`.
- Тест-план для OpenWrt 24.x/filogic, включая сценарии captive/восстановление/перезапуск Wi‑Fi/очистку правил, — в `docs/TEST_PLAN.md`.
- Полевая проверка на реальном AX3000T обязательна после внедрения критических изменений (firewall, health-check, Wi-Fi восстановление).

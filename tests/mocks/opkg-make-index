#!/bin/sh
# Mock opkg-make-index for testing
# opkg-make-index [-a <arch>] <package-dir>

set -eu

. "$(dirname "$0")/_lib.sh"

mock_log opkg-make-index "$@"

if [ "$#" -lt 1 ]; then
    echo "Usage: opkg-make-index [-a <arch>] <package-dir>" >&2
    exit 1
fi

arch=""
pkg_dir=""

# Parse arguments
while [ "$#" -gt 0 ]; do
    case "$1" in
        -a)
            if [ $# -lt 2 ]; then
                echo "error: -a requires an argument" >&2
                exit 1
            fi
            arch="$2"
            shift 2
            ;;
        -*)
            echo "error: unknown option: $1" >&2
            exit 1
            ;;
        *)
            pkg_dir="$1"
            shift
            ;;
    esac
done

if [ -z "$pkg_dir" ]; then
    echo "error: package directory not specified" >&2
    exit 1
fi

if [ ! -d "$pkg_dir" ]; then
    echo "error: package directory not found: $pkg_dir" >&2
    exit 1
fi

# Generate Packages index for all .ipk files in the directory
output=""

for ipk in "$pkg_dir"/*.ipk; do
    [ -f "$ipk" ] || continue

    tmpdir=$(mktemp -d)
    trap "rm -rf '$tmpdir'" EXIT

    # Extract control file from .ipk
    ar p "$ipk" control.tar.gz 2>/dev/null | tar -C "$tmpdir" -xz 2>/dev/null || true

    if [ -f "$tmpdir/control" ]; then
        # Add control file content to output
        output="$output$(cat "$tmpdir/control")
Filename: $(basename "$ipk")
Size: $(stat -c%s "$ipk")
MD5sum: $(md5sum "$ipk" | awk '{print $1}')
SHA256sum: $(sha256sum "$ipk" | awk '{print $1}')

"
    fi
done

# Output the Packages index
if [ -n "$output" ]; then
    printf '%s' "$output"
fi

exit 0

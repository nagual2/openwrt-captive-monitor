# Backlog плана доработок

Оценки указаны в условных днях разработки (d) и включают код,
ревью и базовое тестирование. Приоритеты: P0 — критично для
запуска на OpenWrt 24.x/filogic, P1 — важно, P2 — желательно.

## Итерация 1 — Стабилизация и совместимость
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Заменить использование `resolveip -s` на поддерживаемый стек (nslookup/host
+ контроль времени ожидания) | P0 | 0.5d | BusyBox не поддерживает `-s`,
из-за чего определение IP captive-портала может провалиться. Нужно
покрыть IPv4/IPv6 и fallback на системный DNS. |
| Переписать health-check: добавить HTTP/HTTPS probes, экспоненциальный бэкофф
и отдельные таймауты для gateway/internet | P0 | 1.5d | Исключит бесконечные
перезапуски Wi‑Fi в сетях с заблокированным ICMP и обеспечит
диагностику порталов без явного 204. |
| Укрепить интеграцию с `fw4`/nftables и `iptables-nft` (выбор backend, порядок
цепочек, корректный cleanup при `fw4 reload`) | P0 | 2d | Проверить, что
таблица `captive_monitor` переустанавливается после `fw4 reload`, а fallback на
iptables корректно работает на iptables-nft. |
| Улучшить init-скрипт: реализовать `depends()`, использовать `procd_kill` в
`stop_service`, пробрасывать недостающие UCI переменные | P1 | 0.5d |
Предотвратит зависшие процессы и обеспечит корректную
перезагрузку службы. |
| Автоматический выбор интерфейсов для Filogic (по `ubus network.wireless`,
`network.lan.device`) и валидация конфигурации | P1 | 1d | Значения по
умолчанию (`phy1-sta0`/`wwan`) не совпадают с AX3000T. Нужны проверяемые
дефолты и понятные ошибки. |
| Проверка зависимостей при старте (`curl`, `busybox httpd`, `nft`, `iptables`, `dnsmasq`)
с понятными подсказками | P1 | 0.5d | Улучшит диагностику кастомных
сборок и избавит от немых падений скрипта. |
| Дополнительные guard'ы в cleanup (восстановление iptables/nft правил при
краше, защита от двойного вызова) | P1 | 0.5d | Снизит риск утечек
правил после аварийного завершения или `kill -9`. |

## Итерация 2 — UX и наблюдаемость
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Расширить UCI: таймауты/интервалы health-check, HTTP порт, выбор firewall backend,
политика IPv6 | P1 | 1d | Вынести значения из переменных окружения,
документировать дефолты для 24.x. |
| Переработать логирование: уровни (`info/warn/error`), ключ `--syslog-only`,
сгруппированный вывод в monitor-режиме | P1 | 0.5d | Снизит шум в `logread` и
облегчит поддержку. |
| Подготовить HTML landing page (busybox httpd) и опциональный HTTPS (self-signed) | P1 | 1.5d
| Улучшит UX пользователей captive порталов. |
| Интеграция с `ubus`: экспорт активного состояния, backend, текущих
таймеров, событий смены статуса | P2 | 1d | Позволит LuCI и
автоматизации показывать состояние сервиса. |
| Документировать troubleshooting (fw4 reload, dnsmasq конфликт, mt76 особенности) и
обновить README | P2 | 0.5d | Использовать результаты тестов и полевых
испытаний. |
| Добавить поддержу whitelist/blacklist доменов и MAC-адресов в UCI | P2 | 1d |
Упростит настройку для частных сетей с исключениями. |

## Итерация 3 — Пакетирование и CI/CD
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Расширить CI: существующий workflow дополнить запуском `scripts/build_ipk.sh
--arch aarch64_cortex-a53` и публикацией артефактов | P1 | 1.5d | Гарантия, что
пакет собирается для Filogic, и получение IPK для тестов. |
| Подготовить контейнер/SDK профиль OpenWrt 24.x с mock-инструментами (nft,
dnsmasq, curl) для smoke-тестов | P1 | 2d | Позволит прогонять сценарии
captive/cleanup без железа и ловить регрессии. |
| Финализировать стиль: прогнать `shfmt -w` по всему репозиторию
(после утверждения тестов) | P1 | 1d | После автоматизации тестов
риск минимален, diffs будут чистыми. |
| Добавить скриптовые/`bats` тесты для функций firewall/dnsmasq и health-check | P2 |
1.5d | Покрыть критические сценарии (fw4 reload, dnsmasq rebuild, чистка
правил). |
| Автоматизировать релизы: changelog, подпись, выкладка в opkg feed и GitHub
Release | P2 | 1d | Поверх `scripts/build_ipk.sh` и `docs/RELEASE_CHECKLIST.md`. |
| Подготовить набор примерных конфигов для разных сценариев
(гостевой Wi-Fi, точка с IPv6, WAN-over-Cellular) | P2 | 0.5d | Упростит внедрение и
ускорит полевые тесты. |

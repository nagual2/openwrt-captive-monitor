# Backlog плана доработок

Оценки указаны в условных днях разработки (d) и включают код, ревью и базовое тестирование. Приоритеты: P0 — критично для запуска на OpenWrt 24.x/filogic, P1 — важно, P2 — желательно.

## Итерация 1 — Стабилизация и совместимость
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Заменить `resolveip -s` на рабочий для BusyBox стек (nslookup/host + `ubus network.wireless`) | P0 | 0.5d | Без исправления IPv4/IPv6 адреса портала не будут определяться на OpenWrt 24.x. |
| Переписать health-check: добавить HTTP/HTTPS probe, экспоненциальный бэкофф, явное сообщение при сбое ICMP | P0 | 1.5d | Нужно для сетей с блокировкой ping и captive-порталов без 204-ответов. |
| Укрепить интеграцию с fw4/nftables и iptables-nft (проверка backend, порядок цепочек, корректный cleanup при `fw4 reload`) | P0 | 2d | Цель — избежать конфликтов с основным ruleset на Filogic и предотвратить утечки правил. |
| Дополнить init-скрипт: `depends()`, `procd_kill` в `stop_service`, проброс UCI переменных (LAN_IPV6, CAPTIVE_CHECK_URLS, firewall backend) | P1 | 0.5d | Повысит надёжность рестартов и корректность oneshot режима. |
| Автодетект интерфейсов (DSA br-lan, стационарное/роуминговое Wi-Fi имя) и валидация конфигурации | P1 | 1d | Конфигурация по умолчанию не подходит для Xiaomi AX3000T, нужно автоматически выбирать интерфейсы. |
| Проверка зависимостей при старте (`curl`, `busybox httpd`, `dnsmasq`) с понятными подсказками | P1 | 0.5d | Избежать немых падений при кастомных сборках. |

## Итерация 2 — UX и наблюдаемость
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Расширить UCI: таймауты/интервалы health-check, HTTP порт, выбор firewall backend, политика IPv6 | P1 | 1d | Вынести параметры из окружения и задокументировать значения по умолчанию для 24.x. |
| Ввести логические уровни (`info/warn/error`) с ключом `--quiet/--syslog-only` + консистентный префикс | P1 | 0.5d | Снизит шум в monitor-режиме и облегчит анализ `logread`. |
| Подготовить captive landing page (HTML) с инструкциями и опциональным HTTPS (self-signed) | P1 | 1.5d | Улучшит UX пользователей, подключающихся к порталу. |
| Интеграция с `ubus`: экспорт статуса (active portal, backend, таймера) и события state change | P2 | 1d | Позволит отображать состояние в LuCI/automations. |
| Документировать известные сценарии (Troubleshooting для nft/iptables, DNS утечки, mt76 quirks) | P2 | 0.5d | Использовать результаты тестов и наблюдений с AX3000T. |

## Итерация 3 — Пакетирование и CI/CD
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Добавить GitHub Actions job, вызывающий `scripts/build_ipk.sh --arch aarch64_cortex-a53` и публикующий артефакт | P1 | 1.5d | Проверка сборки под Filogic целевую архитектуру и подготовка бинарных артефактов. |
| Подготовить контейнер/SDK профиль OpenWrt 24.x для автоматических smoke-тестов (nft, dnsmasq, Wi-Fi mocks) | P1 | 2d | Позволит прогонять сценарии captive/cleanup без железа. |
| Финализировать стиль: утвердить и применить `shfmt -i 2` по всему репозиторию | P1 | 1d | После наличия тестов риск массового форматирования снижается. |
| Расширить CI: запуск unit/bats тестов для функций firewall/dnsmasq cleanup | P2 | 1.5d | Блокирует регрессии при правках логики. |
| Автоматизировать релизы: генерация changelog, push в opkg feed, GitHub Release | P2 | 1d | Поверх `scripts/build_ipk.sh` и `docs/RELEASE_CHECKLIST.md`. |

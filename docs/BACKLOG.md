# Backlog плана доработок

Оценки указаны в условных днях разработки (d) и включают код, ревью и базовое тестирование. Приоритет: P0 — критично, P1 — важно, P2 — желательно.

## Итерация 1 — Стабилизация и совместимость
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Переписать обнаружение DNS/IP-адресов без `resolveip -s`, оставить надёжный fallback на `nslookup`/`ubus call network.interface.sta` | P0 | 0.5d | Текущее использование `resolveip -s` не поддерживается BusyBox в OpenWrt 22/23/24. |
| Расширить определение фаервола: корректно обрабатывать `iptables-nft`, `fw4` reload и документировать требуемые capabilities | P0 | 2d | Добавить проверку `iptables -V`, fallback на `fw4` hooks (через `fw4` user includes) и автоматическое удаление правил при `fw4 reload`. |
| Сделать health-check устойчивым к блокировке ICMP: добавить HTTP(S) probe с тайм-аутами и бэкоффом | P0 | 1.5d | Использовать `curl --head`/`wget --spider`, добавить экспоненциальную задержку между попытками. |
| Обработать отсутствие `curl`: проверять зависимость при старте, выводить actionable hint и/или fallback на `wget-ssl` | P0 | 0.5d | Улучшить пользовательское сообщение, обновить README. |
| Улучшить автоопределение LAN/Wi-Fi интерфейсов (DSA, multi-SSID) и ошибки конфигурации | P1 | 1d | Разобрать `ubus call network.wireless status`, поддержать VLAN/bridge имена. |
| Добавить unit-скрипты/`bats`-тесты для функций очистки iptables/nft, dnsmasq конфигов | P1 | 1.5d | Покрыть edge cases выхода из monitor-режима. |
| Интегрировать init-скрипт с `depends()` и корректным `procd_kill` в `stop_service` | P1 | 0.5d | Обеспечить последовательность запуска/остановки вместе с `dnsmasq` и `network`. |

## Итерация 2 — Улучшение UX и наблюдаемости
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Стандартизировать уровни логов и добавить ключ `--quiet/--syslog-only` | P1 | 1d | Поможет в monitor-режиме и при oneshot запуске из cron. |
| Расширить UCI-настройки (HTTP порт, список health-check URL, тайм-ауты, выбор backend'а) и добавить в документацию примеры | P1 | 1d | Сейчас часть параметров возможно изменить только через env. |
| Добавить landing-page HTML с локализованным сообщением и fallback на HTTPS (self-signed) | P1 | 2d | Улучшит UX пользователей captive-порталов. |
| Интеграция с `ubus` событиями (логирование state change) | P2 | 1d | Позволит наблюдать состояние из LuCI. |
| Дополнить README разделом «Troubleshooting» (iptables/nft, DNS leaks, Wi-Fi) | P2 | 0.5d | Опирается на выводы аудита. |

## Итерация 3 — Пакетирование и CI/CD
| Задача | Приоритет | Оценка | Комментарии |
| --- | --- | --- | --- |
| Финализировать переход на единый стиль (shfmt -i 2) и прогнать автоформатирование | P1 | 1d | Разделить на отдельный PR, согласовать с командой. |
| Добавить GitHub Actions job для сборки IPK и артефактов (matrix по архитектурам) | P1 | 2d | Поверх существующего `openwrt-build.yml`, использовать SDK контейнер. |
| Подготовить контейнер/runner образ с OpenWrt rootfs для автоматизированных smoke-тестов | P2 | 2d | Запускать скрипт в chroot с имитацией dnsmasq/fw4. |
| Опубликовать пример feed'а и Makefile для внешнего опк-фида | P2 | 1d | Упростить интеграцию в CI и документацию. |
| Автоматизировать генерацию changelog и релизных артефактов (GitHub Releases) | P2 | 1d | Сценарий поверх existing docs/RELEASE_CHECKLIST.md. |

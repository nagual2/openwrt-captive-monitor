# –¢–µ—Å—Ç-–ø–ª–∞–Ω OpenWrt Captive Monitor (OpenWrt 24.x / filogic / Xiaomi Mi Router AX3000T)

---

## üåê Language / –Ø–∑—ã–∫

**English** | [–†—É—Å—Å–∫–∏–π](#—Ä—É—Å—Å–∫–∏–π)

---


> –ü–æ–ª–µ–≤–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –Ω–µ—Ç ‚Äî –æ–ø–∏—Ä–∞–µ–º—Å—è –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, —ç–º—É–ª—è—Ü–∏—é OpenWrt
> –∏ –∑–∞–≤–µ—Ä—à–∞—é—â–∏–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.

## 1. –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ CI)

- `shfmt -i 2 -ci -sr -d $(git ls-files '*.sh')` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è `.shfmt.conf`
- `shellcheck -s sh <files>` ‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ shell-—Å–∫—Ä–∏–ø—Ç–æ–≤
- `sh -n package/openwrt-captive-monitor/files/etc/init.d/captive-monitor` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ init-—Å–∫—Ä–∏–ø—Ç–∞
- `scripts/build_ipk.sh --arch aarch64_cortex-a53` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ IPK

### –¢–µ—Å—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

–ò—Å–ø–æ–ª—å–∑—É–µ–º mock –±–∏–Ω–∞—Ä–µ–π `ip`, `nft`, `iptables`, `dnsmasq`, `curl`:

- `detect_firewall_backend`
- `setup_firewall_redirects_*`
- `cleanup_firewall_redirects_*`
- `write_dnsmasq_intercept`
- `ensure_lan_interface`
- `restart_wifi_*` (—Å —Å–∏–º—É–ª—è—Ü–∏–µ–π –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–†—É—á–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Å –ø–æ–¥–º–µ–Ω–æ–π `PATH`:

```bash
openwrt_captive_monitor --oneshot
openwrt_captive_monitor --monitor
```

## 2. –≠–º—É–ª—è—Ü–∏—è OpenWrt 24.x (SDK/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
   - –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å rootfs OpenWrt 24.02 (mediatek/filogic)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `openwrtorg/rootfs:x86-64`
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
     - `nftables`
     - `iptables-nft`
     - `dnsmasq-full`
     - `curl`
     - `busybox httpd`

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞**:
   ```bash
   opkg install ./openwrt-captive-monitor_*.ipk
   ```

3. **–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:

   - **–†–∞–±–æ—á–∏–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç**:
     ```bash
     openwrt_captive_monitor --oneshot
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ captive-—Ä–µ–∂–∏–º –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã nft –ø—É—Å—Ç—ã
     ```

   - **WAN down / –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ICMP**:
     ```bash
     # –ó–∞–ø—Ä–µ—Ç–∏—Ç—å ping –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–æ —à–ª—é–∑–∞
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –±—ç–∫–æ—Ñ—Ñ–æ–º
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
     ```

   - **Captive portal**:
     ```bash
     # –ü–æ–¥–Ω—è—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π HTTP
     # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNAT/DNS –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—Å–∫ busybox httpd
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é dnsmasq.d/captive_intercept.conf
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
     ```

   - **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ backend'–æ–≤**:
     ```bash
     # –ó–∞–ø—É—Å–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ –±—ç–∫–µ–Ω–¥–∞–º–∏
     REQUESTED_FIREWALL_BACKEND=nftables openwrt_captive_monitor
     REQUESTED_FIREWALL_BACKEND=iptables openwrt_captive_monitor
     
     # –°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–≤–æ–¥
     nft list ruleset
     iptables-save
     ```

   - **fw4 reload**:
     ```bash
     # –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å
     /etc/init.d/captive-monitor start
     
     # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å fw4
     fw4 reload
     
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
     nft list ruleset
     ```

   - **–ê–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**:
     ```bash
     # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
     /etc/init.d/captive-monitor start
     
     # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å
     kill -9 $(pgrep -f openwrt_captive_monitor)
     
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–∏—Å—Ç–∫—É
     nft list ruleset
     iptables-save
     ```

   - **IPv6 / dual-stack**:
     ```bash
     # –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ SLAAC
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫—É IPv6 DNAT
     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä DNS
     ```

## 2.5. –í–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (QEMU VM)

–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–º. –≤ [Virtualized Testing Guide](guides/virtualized-testing.md).

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- **–ü–æ–ª–Ω–∞—è —ç–º—É–ª—è—Ü–∏—è OpenWrt:** –ù–∞—Å—Ç–æ—è—â–∞—è —Å–µ—Ç–µ–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—è –∏ firewall
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤ CI:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitHub Actions
- **–†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- **–û—Ç–ª–∞–¥–∫–∞:** –î–æ—Å—Ç—É–ø –∫ –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —á–µ—Ä–µ–∑ SSH

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ OpenWrt
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ init-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ UCI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏  
- –í–∞–ª–∏–¥–∞—Ü–∏—è firewall –ø—Ä–∞–≤–∏–ª (iptables/nftables)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS/HTTP redirects
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ cleanup –ø—Ä–æ—Ü–µ–¥—É—Ä

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ QEMU TCG (–±–µ–∑ nested virtualization)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ OpenWrt –æ–±—Ä–∞–∑–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤
- –°–±–æ—Ä –ª–æ–≥–æ–≤ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## 3. –ü–æ–ª–µ–≤—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –Ω–∞ Xiaomi Mi Router AX3000T
1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**:
   - –ü—Ä–æ—à–∏–≤–∫–∞ OpenWrt 24.02
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ –∏–∑ feed
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UCI (`wifi_interface`, —Ä–µ–∂–∏–º—ã, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, backend)
2. **–°—Ü–µ–Ω–∞—Ä–∏–∏**:
   - `openwrt_captive_monitor --oneshot` –ø—Ä–∏ —Ä–∞–±–æ—á–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ ‚Äî —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –ø—Ä–∞–≤–∏–ª–∞ –Ω–µ –æ—Å—Ç–∞—é—Ç—Å—è.
   - **WAN down**:
     - –û—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
     - –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Wi‚ÄëFi
     - –ê–∫—Ç–∏–≤–∞—Ü–∏—è captive-—Ä–µ–∂–∏–º–∞
     - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π rollout –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞
   - **–†–µ–∞–ª—å–Ω—ã–π captive portal**:
     - –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ç–∏ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—É–±–ª–∏—á–Ω—ã–π —Ö–æ—Ç-—Å–ø–æ—Ç)
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–∏—â–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   - **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Wi‚ÄëFi –≤—Ä—É—á–Ω—É—é**:
     - –í—ã–ø–æ–ª–Ω–∏—Ç—å `wifi down/up`
     - –í—ã–ø–æ–ª–Ω–∏—Ç—å `ifdown/ifup` –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
     - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –Ω–µ —Ç–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
   - **fw4 reload / firewall restart**:
     - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
     - –í—ã–ø–æ–ª–Ω–∏—Ç—å `fw4 reload`
     - –í—ã–ø–æ–ª–Ω–∏—Ç—å `service firewall restart`
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–ª–∏–ø–∞–Ω–∏–π
   - **IPv6**:
     - –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π IPv6-–ø–æ–¥—Å–µ—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
       - –ü–æ–≤–µ–¥–µ–Ω–∏–µ `ensure_lan_ipv6`
       - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
       - –û—á–∏—Å—Ç–∫—É IPv6 DNAT
   - **Stress (12‚Äì24 —á)**:
     - –û—Å—Ç–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å –≤ monitor-—Ä–µ–∂–∏–º–µ
     - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
       - `logread`
       - `nft list ruleset`
       - `ps`
       - `top`
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã
3. **–°–±–æ—Ä –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤**:
   - `logread`
   - `dmesg`
   - `nft list ruleset`
   - `iptables-save`
   - `/tmp/dnsmasq.d/captive_intercept.conf`
   - `/tmp/captive_httpd/`
   - –°—Ç–∞—Ç—É—Å UCI

## 4. –†–µ–≥—Ä–µ—Å—Å–∏—è –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
- –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏ —ç–º—É–ª—è—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø—Ä–∞–≤–∫–∏:
  - Firewall
  - Health-check
  - Init-—Å–∫—Ä–∏–ø—Ç—ã
- –ü—Ä–æ–π—Ç–∏ —á–µ–∫-–ª–∏—Å—Ç `docs/RELEASE_CHECKLIST.md` (–≤–µ—Ä—Å–∏—è, changelog, –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π).
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
  - `opkg files openwrt-captive-monitor`
  - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π –≤:
    - `/etc/config`
    - `/etc/init.d`
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ –æ—Å—Ç–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ—Å–ª–µ:
  - `fw4 reload`
  - `service captive-monitor restart`
  - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –ü—Ä–æ–≤–µ—Å—Ç–∏ smoke-—Ç–µ—Å—Ç `scripts/build_ipk.sh` –≤ CI –∏ –≤—Ä—É—á–Ω—É—é —É–¥–æ—Å—Ç–æ–≤–µ—Ä–∏—Ç—å—Å—è, —á—Ç–æ –ø–∞–∫–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ —É–¥–∞–ª—è–µ—Ç—Å—è (`opkg remove`).
